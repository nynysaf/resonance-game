<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Resonance Game</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Righteous&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Josefin+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ─── DESIGN TOKENS ─────────────────────────────────────────────── */
:root {
  --mint:       #ADF7F5;
  --pink:       #E996F5;
  --lavender:   #C6C6F5;
  --yellow:     #F4F597;
  --offwhite:   #F7F7F7;
  --teal:       #0D7377;
  --teal-mid:   #14919B;
  --magenta:    #8B1A8B;
  --dark:       #1A1A2E;
  --dark2:      #12122A;
  --gray:       #888;
  --card-r:     16px;
  --shadow-card: 0 8px 40px rgba(13,115,119,0.13);
  --shadow-hover:0 16px 60px rgba(13,115,119,0.22);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  font-family:'Josefin Sans',sans-serif;
  background:#0e0e1f;
  color:var(--dark);
  overflow-x:hidden;
  min-height:100vh;
}

/* ─── VIEWS ──────────────────────────────────────────────────────── */
.view{display:none;min-height:100vh;animation:fadeUp 0.45s ease both}
.view.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* ─── NAV ────────────────────────────────────────────────────────── */
.nav{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 32px;
  background:rgba(14,14,31,0.9);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(173,247,245,0.12);
}
.nav-badge{
  background:white;border:2px solid var(--dark);border-radius:8px;
  padding:4px 10px;box-shadow:3px 3px 0 var(--teal);
  display:flex;flex-direction:column;align-items:center;line-height:1;
  cursor:pointer;transition:transform 0.2s;
}
.nav-badge:hover{transform:translateY(-1px)}
.nav-badge .the{font-size:7px;font-weight:700;letter-spacing:4px;color:var(--magenta)}
.nav-badge .res{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--dark)}
.nav-badge .game{font-size:6px;font-weight:300;letter-spacing:5px;color:var(--teal);border-top:1px solid var(--dark);padding-top:2px;width:100%;text-align:center}
.nav-right{display:flex;align-items:center;gap:12px}
.nav-session-code{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:4px;color:var(--yellow);display:none}
.nav-phase-badge{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.4)}

/* ─── HERO BACKGROUNDS ───────────────────────────────────────────── */
.dark-hero{
  background:linear-gradient(155deg,var(--dark2) 0%,#1a0a2e 40%,#0d2a2e 100%);
  position:relative;overflow:hidden;
}
.dark-hero::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  opacity:0.035;mix-blend-mode:overlay;
}
.sun-wrap{
  position:absolute;top:-120px;right:-120px;
  width:640px;height:640px;pointer-events:none;
}
.sun-wrap svg{width:100%;height:100%;animation:rotateSun 60s linear infinite}
@keyframes rotateSun{to{transform:rotate(360deg)}}

.stripe-band{display:flex;height:5px;width:100%}
.stripe-band div{flex:1}

/* ─── CARD ────────────────────────────────────────────────────────── */
.card{
  background:rgba(247,247,247,0.04);
  border:1px solid rgba(173,247,245,0.12);
  border-radius:var(--card-r);
  backdrop-filter:blur(8px);
  transition:transform 0.3s ease,box-shadow 0.3s ease,border-color 0.3s;
}
.card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);border-color:rgba(173,247,245,0.3)}
.card-inner{padding:32px}

/* ─── BUTTON BASE ────────────────────────────────────────────────── */
.btn{
  font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;border:none;border-radius:10px;cursor:pointer;
  transition:all 0.25s;display:inline-flex;align-items:center;justify-content:center;gap:8px;
}
.btn-primary{background:linear-gradient(135deg,var(--mint),#7eecea);color:var(--dark);padding:14px 28px;font-size:12px}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(173,247,245,0.35)}
.btn-secondary{background:rgba(173,247,245,0.12);color:var(--mint);border:1px solid rgba(173,247,245,0.25);padding:12px 22px;font-size:11px}
.btn-secondary:hover{background:rgba(173,247,245,0.2)}
.btn-teal{background:var(--teal);color:white;padding:13px 24px;font-size:12px}
.btn-teal:hover{background:#0a5c5f;transform:translateY(-2px);box-shadow:0 8px 28px rgba(13,115,119,0.4)}
.btn-outline{background:transparent;color:var(--teal);border:2px solid var(--teal);padding:11px 22px;font-size:11px}
.btn-outline:hover{background:rgba(13,115,119,0.08);transform:translateY(-2px)}
.btn-danger{background:transparent;color:#ff6b6b;border:2px solid #ff6b6b;padding:11px 22px;font-size:11px}
.btn-danger:hover{background:rgba(255,107,107,0.1)}
.btn:disabled{opacity:0.45;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* ─── FORM ELEMENTS ──────────────────────────────────────────────── */
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(173,247,245,0.6);font-weight:700;margin-bottom:8px}
.form-input{
  width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(173,247,245,0.2);
  border-radius:8px;padding:12px 16px;
  font-family:'Josefin Sans',sans-serif;font-size:14px;color:white;letter-spacing:0.5px;
  outline:none;transition:border-color 0.2s;
}
.form-input:focus{border-color:rgba(173,247,245,0.5);background:rgba(255,255,255,0.09)}
.form-input::placeholder{color:rgba(255,255,255,0.25)}
.form-input.light{background:white;border-color:rgba(13,115,119,0.2);color:var(--dark)}
.form-input.light:focus{border-color:var(--teal)}
.form-input.light::placeholder{color:var(--gray)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-hint{font-size:10px;letter-spacing:1px;color:rgba(255,255,255,0.3);margin-top:6px}
.form-hint.light{color:var(--gray)}
.code-status{display:inline-flex;align-items:center;gap:6px;font-size:11px;letter-spacing:1px;margin-top:6px}
.code-ok{color:#4ecdc4}
.code-err{color:#ff6b6b}
select.form-input{cursor:pointer}
select.form-input option{background:#1a1a2e}

/* ─── HERO TEXT ──────────────────────────────────────────────────── */
.hero-eyebrow{font-size:11px;font-weight:700;letter-spacing:7px;color:rgba(173,247,245,0.6);text-transform:uppercase;margin-bottom:16px;animation:fadeUp 0.8s 0.1s ease both}
.hero-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(72px,12vw,140px);letter-spacing:6px;line-height:0.92;background:linear-gradient(135deg,var(--mint) 0%,white 45%,var(--pink) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 40px rgba(173,247,245,0.25));animation:fadeUp 0.8s 0.2s ease both}
.hero-sub{font-family:'Bebas Neue',sans-serif;font-size:clamp(28px,4vw,52px);letter-spacing:18px;color:var(--pink);margin-top:4px;animation:fadeUp 0.8s 0.3s ease both}
.hero-tagline{font-family:'Playfair Display',serif;font-style:italic;font-size:17px;color:rgba(255,255,255,0.5);margin-top:20px;letter-spacing:0.5px;animation:fadeUp 0.8s 0.4s ease both}

/* ─── PARTICIPANTS LIST ───────────────────────────────────────────── */
.participant-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;border-radius:10px;
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);
  animation:slideIn 0.4s ease both;
}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.p-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--dark);flex-shrink:0}
.p-name{font-size:13px;font-weight:600;color:rgba(255,255,255,0.85);letter-spacing:0.5px}
.p-joined{font-size:10px;color:var(--gray);letter-spacing:1px}
.p-status{margin-left:auto}
.dot-pulse{width:8px;height:8px;border-radius:50%;background:var(--mint);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}

/* ─── QR PANEL ───────────────────────────────────────────────────── */
.qr-box{background:white;border-radius:12px;padding:16px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
.join-url-row{display:flex;gap:8px;align-items:center}
.join-url{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(173,247,245,0.2);border-radius:8px;padding:10px 14px;font-family:'Josefin Sans',sans-serif;font-size:12px;color:var(--mint);letter-spacing:1px}
.copy-btn{background:var(--mint);color:var(--dark);border:none;border-radius:8px;padding:10px 16px;font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.copy-btn:hover{background:white;transform:scale(1.04)}
.session-code-val{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:8px;color:var(--yellow);filter:drop-shadow(0 0 12px rgba(244,245,151,0.4))}

/* ─── PROGRESS ────────────────────────────────────────────────────── */
.progress-bar-bg{height:7px;background:rgba(13,115,119,0.15);border-radius:4px;overflow:hidden}
.progress-bar-fill{height:100%;border-radius:4px;transition:width 0.8s ease}
.progress-pct{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--teal)}

/* ─── LIGHT SECTION ──────────────────────────────────────────────── */
.light-section{background:var(--offwhite);min-height:100vh}
.light-header{background:var(--teal);padding:16px 32px;display:flex;align-items:center;justify-content:space-between}
.light-content{max-width:580px;margin:0 auto;padding:48px 24px 140px}

/* ─── VOTING CARD ────────────────────────────────────────────────── */
.card-stack-wrap{position:relative;height:280px;margin-bottom:40px}
.statement-card{
  position:absolute;inset:0;background:white;border-radius:20px;
  box-shadow:var(--shadow-card);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 36px;
  border:1.5px solid rgba(198,198,245,0.5);
  transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.ghost-card{background:rgba(198,198,245,0.25);border:1.5px solid rgba(198,198,245,0.2)}
.ghost-card-1{transform:translate(0,8px) scale(0.97);z-index:1}
.ghost-card-2{transform:translate(0,16px) scale(0.94);z-index:0}
.active-card{z-index:2}
.statement-number{position:absolute;top:16px;right:20px;font-size:11px;letter-spacing:2px;color:var(--gray);font-weight:700}
.statement-text{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(17px,3vw,21px);color:var(--dark);text-align:center;line-height:1.55}
.statement-author{position:absolute;bottom:16px;font-size:10px;letter-spacing:2px;color:var(--gray);font-weight:600;text-transform:uppercase}

/* ─── VOTE BUTTONS ───────────────────────────────────────────────── */
.vote-section{text-align:center}
.vote-label-row{display:flex;justify-content:space-between;margin-bottom:10px;padding:0 4px}
.vote-label{font-size:10px;letter-spacing:1.5px;color:var(--gray);font-weight:600;text-transform:uppercase}
.vote-buttons{display:flex;gap:12px;justify-content:center;margin-bottom:12px}
.vote-btn{
  width:56px;height:56px;border-radius:50%;
  border:2px solid rgba(13,115,119,0.2);background:white;
  box-shadow:0 4px 16px rgba(0,0,0,0.08),inset 0 1px 0 rgba(255,255,255,0.9);
  cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--dark);
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);
  position:relative;overflow:hidden;
}
.vote-btn::before{content:'';position:absolute;inset:0;border-radius:50%;opacity:0;transition:opacity 0.2s}
.vote-btn:hover{transform:translateY(-4px) scale(1.08);box-shadow:0 8px 24px rgba(13,115,119,0.2)}
.vote-btn.v1::before{background:radial-gradient(circle,rgba(233,150,245,0.9),rgba(233,150,245,0.6))}
.vote-btn.v2::before{background:radial-gradient(circle,rgba(198,198,245,0.9),rgba(198,198,245,0.6))}
.vote-btn.v3::before{background:radial-gradient(circle,rgba(247,247,247,0.9),rgba(220,220,220,0.6))}
.vote-btn.v4::before{background:radial-gradient(circle,rgba(173,247,245,0.9),rgba(100,220,218,0.6))}
.vote-btn.v5::before{background:radial-gradient(circle,rgba(13,115,119,0.9),rgba(13,115,119,0.7))}
.vote-btn.v5{color:var(--teal)}
.vote-btn.selected{transform:translateY(-4px) scale(1.12);border-color:transparent}
.vote-btn.selected::before{opacity:1}
.vnum{position:relative;z-index:1}
.vote-btn.v5.selected .vnum{color:white}

/* ─── CARD NAV ───────────────────────────────────────────────────── */
.card-nav{display:flex;align-items:center;justify-content:space-between;margin-top:24px}
.nav-arrow{display:flex;align-items:center;gap:6px;font-size:11px;letter-spacing:2px;font-weight:700;text-transform:uppercase;color:var(--teal);background:none;border:none;cursor:pointer;padding:8px 4px;transition:all 0.2s}
.nav-arrow:hover{gap:10px}
.nav-arrow.disabled{opacity:0.3;cursor:not-allowed}

/* ─── PROGRESS DOCK ──────────────────────────────────────────────── */
.progress-dock{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(247,247,247,0.96);backdrop-filter:blur(10px);
  border-top:1px solid rgba(13,115,119,0.12);
  padding:14px 24px 20px;
}
.progress-row{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.progress-label{font-size:10px;letter-spacing:2px;font-weight:700;text-transform:uppercase;color:var(--gray);width:64px;flex-shrink:0}

/* ─── TIMER ──────────────────────────────────────────────────────── */
.timer-display{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--yellow);filter:drop-shadow(0 0 8px rgba(244,245,151,0.5))}
.timer-display.urgent{color:#ff6b6b;animation:timerPulse 0.5s ease-in-out infinite}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:0.6}}

/* ─── RESULTS ─────────────────────────────────────────────────────── */
.results-hero{
  background:linear-gradient(135deg,var(--teal) 0%,#0a4a4d 100%);
  padding:40px 32px 60px;text-align:center;position:relative;overflow:hidden;
}
.results-hero::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 70% 50%,rgba(173,247,245,0.15),transparent 60%);
}
.results-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(48px,8vw,80px);letter-spacing:5px;color:white;line-height:1;position:relative}
.results-meta{font-size:12px;letter-spacing:2px;color:rgba(255,255,255,0.5);margin-top:12px;position:relative}
.results-stripe{display:flex;height:4px}
.results-stripe div{flex:1}

/* Tabs */
.tabs-bar{display:flex;max-width:900px;margin:0 auto;border-bottom:2px solid rgba(13,115,119,0.12);padding:0 32px;background:white;position:sticky;top:64px;z-index:50;overflow-x:auto}
.tab-btn{font-family:'Righteous',sans-serif;font-size:13px;letter-spacing:1.5px;padding:16px 24px;border:none;background:transparent;color:var(--gray);cursor:pointer;position:relative;transition:color 0.25s;white-space:nowrap}
.tab-btn::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;border-radius:2px;background:var(--magenta);transform:scaleX(0);transition:transform 0.3s}
.tab-btn.active{color:var(--magenta)}
.tab-btn.active::after{transform:scaleX(1)}

.results-body{max-width:900px;margin:0 auto;padding:40px 32px 100px}
.tab-panel{display:none;animation:fadeUp 0.4s ease}
.tab-panel.active{display:block}

/* Leaderboard rows */
.leaderboard{display:flex;flex-direction:column;gap:12px}
.lb-row{
  display:flex;align-items:center;gap:16px;
  background:white;border-radius:14px;padding:16px 20px;
  box-shadow:0 2px 16px rgba(13,115,119,0.07);
  border:1px solid rgba(13,115,119,0.06);
  transition:all 0.3s;
  animation:fadeUp 0.5s ease both;
}
.lb-row:hover{transform:translateX(4px);box-shadow:0 4px 24px rgba(13,115,119,0.13);border-color:rgba(13,115,119,0.15)}
.lb-rank{font-family:'Bebas Neue',sans-serif;font-size:42px;line-height:1;color:var(--teal);width:44px;flex-shrink:0;text-align:center}
.lb-rank.gold{color:#D4A017}
.lb-rank.silver{color:#9E9E9E}
.lb-rank.bronze{color:#B87333}
.lb-content{flex:1;min-width:0}
.lb-statement{font-family:'Playfair Display',serif;font-style:italic;font-size:15px;color:var(--dark);line-height:1.45;margin-bottom:6px}
.lb-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.lb-author{font-size:10px;letter-spacing:2px;font-weight:700;text-transform:uppercase;color:var(--gray)}
.round-badge{font-size:9px;letter-spacing:1.5px;font-weight:700;text-transform:uppercase;padding:2px 8px;border-radius:20px;background:rgba(198,198,245,0.4);color:var(--magenta)}
.lb-score-col{text-align:right;flex-shrink:0}
.lb-score-num{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1;color:var(--teal)}
.lb-score-denom{font-size:11px;color:var(--gray)}
.lb-votes{font-size:10px;letter-spacing:1px;color:var(--gray)}
.lb-bar-wrap{margin-top:8px}
.lb-bar-bg{height:5px;background:rgba(13,115,119,0.08);border-radius:3px;overflow:hidden}
.lb-bar-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(0.25,1,0.5,1)}

/* People tab */
.people-toggle{display:flex;gap:0;margin-bottom:28px;background:rgba(13,115,119,0.07);border-radius:10px;padding:3px;width:fit-content}
.toggle-btn{padding:8px 20px;border:none;background:transparent;font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--gray);border-radius:8px;cursor:pointer;transition:all 0.25s}
.toggle-btn.active{background:white;color:var(--teal);box-shadow:0 2px 8px rgba(13,115,119,0.1)}
.people-row{display:flex;align-items:center;gap:16px;background:white;border-radius:14px;padding:16px 20px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06);margin-bottom:10px;transition:all 0.3s;animation:fadeUp 0.5s ease both}
.people-row:hover{transform:translateX(4px)}
.people-avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:20px;color:white}
.people-name{font-size:14px;font-weight:600;color:var(--dark)}
.people-stat{font-size:11px;color:var(--gray);letter-spacing:0.5px}
.people-score{margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1;color:var(--teal)}

/* Host FAB */
.host-fab{position:fixed;bottom:32px;right:32px;display:flex;flex-direction:column;gap:10px;z-index:200}
.host-btn{padding:12px 20px;border-radius:12px;border:none;cursor:pointer;font-family:'Josefin Sans',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;transition:all 0.25s;display:flex;align-items:center;gap:8px;white-space:nowrap}
.host-btn.export{background:var(--teal);color:white;box-shadow:0 4px 20px rgba(13,115,119,0.3)}
.host-btn.export:hover{background:#0a5c5f;transform:translateY(-2px);box-shadow:0 8px 28px rgba(13,115,119,0.4)}
.host-btn.add-round{background:var(--lavender);color:var(--dark)}
.host-btn.add-round:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(198,198,245,0.4)}
.host-btn.new-game{background:transparent;color:var(--teal);border:2px solid var(--teal)}
.host-btn.new-game:hover{background:rgba(13,115,119,0.08);transform:translateY(-2px)}

/* ─── TEXTAREA ───────────────────────────────────────────────────── */
.statement-textarea{
  width:100%;border:none;outline:none;resize:none;
  font-family:'Playfair Display',serif;font-style:italic;font-size:18px;
  color:var(--dark);line-height:1.55;text-align:center;
  background:transparent;min-height:120px;
}
.char-counter{font-size:11px;letter-spacing:1px;color:var(--gray)}
.char-counter.warn{color:#ff6b6b}

/* ─── MODAL ──────────────────────────────────────────────────────── */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:2000;display:none;align-items:center;justify-content:center}
.modal-backdrop.active{display:flex}
.modal{background:white;border-radius:20px;padding:40px;max-width:500px;width:calc(100% - 40px);animation:fadeUp 0.3s ease;box-shadow:0 24px 60px rgba(0,0,0,0.25)}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:3px;color:var(--dark);margin-bottom:12px}
.modal-body{font-size:14px;line-height:1.6;color:#555;margin-bottom:28px}
.modal-actions{display:flex;gap:12px;flex-wrap:wrap}

/* ─── TOAST ──────────────────────────────────────────────────────── */
.toast-container{position:fixed;top:80px;right:24px;z-index:3000;display:flex;flex-direction:column;gap:10px;pointer-events:none}
.toast{background:var(--dark);color:white;padding:12px 20px;border-radius:10px;font-size:12px;letter-spacing:1px;font-weight:600;animation:toastIn 0.3s ease;pointer-events:none;border-left:3px solid var(--mint)}
.toast.error{border-left-color:#ff6b6b}
.toast.success{border-left-color:var(--mint)}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(30px)}}

/* ─── WAITING SCREEN ──────────────────────────────────────────────── */
.waiting-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:var(--offwhite);padding:40px 24px;text-align:center}
.waiting-icon{font-size:60px;margin-bottom:24px;animation:pulse 2s ease-in-out infinite}
.waiting-title{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:4px;color:var(--dark);margin-bottom:8px}
.waiting-sub{font-family:'Playfair Display',serif;font-style:italic;font-size:18px;color:var(--gray);margin-bottom:32px}
.waiting-progress{width:100%;max-width:360px;background:rgba(13,115,119,0.1);border-radius:8px;height:10px;overflow:hidden;margin:0 auto 12px}
.waiting-progress-fill{height:100%;background:var(--mint);border-radius:8px;transition:width 0.8s ease}
.waiting-pct{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--teal)}

/* ─── REVIEW SCREEN ──────────────────────────────────────────────── */
.review-list{display:flex;flex-direction:column;gap:12px;margin-bottom:28px}
.review-item{background:white;border-radius:14px;padding:20px 24px;box-shadow:0 2px 12px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.08);position:relative}
.review-num{font-size:10px;letter-spacing:3px;font-weight:700;color:var(--teal);text-transform:uppercase;margin-bottom:8px}
.review-text{font-family:'Playfair Display',serif;font-style:italic;font-size:16px;color:var(--dark);line-height:1.5}
.review-edit{position:absolute;top:16px;right:16px;background:transparent;border:1px solid rgba(13,115,119,0.2);border-radius:6px;padding:4px 10px;font-size:10px;letter-spacing:2px;font-weight:700;color:var(--teal);cursor:pointer;font-family:'Josefin Sans',sans-serif;text-transform:uppercase;transition:all 0.2s}
.review-edit:hover{background:var(--teal);color:white}

/* ─── SECTION HEADERS ────────────────────────────────────────────── */
.section-label{font-size:10px;letter-spacing:4px;text-transform:uppercase;color:var(--mint);font-weight:700;margin-bottom:20px}
.section-label.dark{color:var(--teal)}

/* ─── RESPONSIVE ──────────────────────────────────────────────────── */
@media(max-width:768px){
  .title-cols{grid-template-columns:1fr!important}
  .form-row{grid-template-columns:1fr!important}
  .nav{padding:12px 16px}
  .results-body{padding:24px 16px 80px}
  .tabs-bar{padding:0 12px}
  .host-fab{bottom:16px;right:16px}
}
@media(max-width:600px){
  .light-content{padding:32px 16px 140px}
}

/* ─── SWEEP REVEAL (results) ──────────────────────────────────────── */
.sweep-reveal{
  position:fixed;inset:0;z-index:5000;
  background:var(--teal);
  transform:translateY(100%);
  pointer-events:none;
}
.sweep-reveal.active{animation:sweepUp 0.9s cubic-bezier(0.76,0,0.24,1) forwards}
@keyframes sweepUp{
  0%{transform:translateY(100%)}
  40%{transform:translateY(0%)}
  70%{transform:translateY(0%)}
  100%{transform:translateY(-100%)}
}

/* ─── SCATTER CHART ──────────────────────────────────────────────── */
.scatter-chart-wrap{background:white;border-radius:16px;padding:28px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06);margin-top:24px}
.scatter-area{position:relative;height:200px;margin-top:12px;border-left:1px solid rgba(13,115,119,0.15);border-bottom:1px solid rgba(13,115,119,0.15)}
.scatter-dot{position:absolute;border-radius:50%;cursor:pointer;transition:transform 0.25s;display:flex;align-items:center;justify-content:center}
.scatter-dot:hover{transform:scale(1.4)!important;z-index:10}
.scatter-tooltip{position:absolute;bottom:calc(100%+8px);left:50%;transform:translateX(-50%);background:var(--dark);color:white;font-size:10px;border-radius:6px;padding:6px 10px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:20}
.scatter-dot:hover .scatter-tooltip{opacity:1}
.scatter-labels{display:flex;justify-content:space-between;font-size:9px;letter-spacing:1px;color:var(--gray);margin-top:6px;padding:0 4px}

/* Host progress bar (teal bg) */
.host-progress-bar{background:rgba(255,255,255,0.15);border-radius:4px;height:8px;overflow:hidden;margin:8px 0}
.host-progress-fill{height:100%;background:var(--mint);border-radius:4px;transition:width 0.8s ease}
.host-pct-label{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--yellow)}

/* Phase badge */
.phase-badge{display:inline-flex;align-items:center;gap:6px;font-size:10px;letter-spacing:3px;text-transform:uppercase;font-weight:700;padding:4px 12px;border-radius:20px}
.phase-badge.lobby{background:rgba(173,247,245,0.12);color:var(--mint)}
.phase-badge.submitting{background:rgba(244,245,151,0.15);color:var(--yellow)}
.phase-badge.voting{background:rgba(233,150,245,0.15);color:var(--pink)}
.phase-badge.results{background:rgba(13,115,119,0.15);color:var(--mint)}

/* Extend timer btn */
.extend-btn{background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.25);border-radius:6px;padding:4px 10px;font-size:10px;letter-spacing:2px;font-weight:700;cursor:pointer;font-family:'Josefin Sans',sans-serif;transition:all 0.2s}
.extend-btn:hover{background:rgba(255,255,255,0.25)}

/* ─── CREATE GAME FORM ────────────────────────────────────────────── */
#view-create{
  background:linear-gradient(155deg,var(--dark2) 0%,#1a0a2e 40%,#0d2a2e 100%);
  min-height:100vh;padding-top:64px;
}
.create-container{max-width:680px;margin:0 auto;padding:60px 32px 80px}
.create-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(44px,7vw,80px);letter-spacing:5px;line-height:0.92;background:linear-gradient(135deg,var(--mint) 0%,white 45%,var(--pink) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.create-sub{font-family:'Playfair Display',serif;font-style:italic;font-size:16px;color:rgba(255,255,255,0.5);margin-bottom:40px}

/* ─── LANDING PAGE ────────────────────────────────────────────────── */
#view-landing{padding-top:64px}
.title-cols{display:grid;grid-template-columns:1fr 1fr;gap:28px;max-width:1100px;margin:0 auto;padding:0 32px 80px;position:relative;z-index:2}
.title-hero{display:flex;flex-direction:column;align-items:center;padding:80px 32px 60px;position:relative;z-index:2;text-align:center}

/* Join button on landing */
.join-panel{background:rgba(247,247,247,0.04);border:1px solid rgba(173,247,245,0.12);border-radius:16px;backdrop-filter:blur(8px);padding:32px}
.join-code-input{display:flex;gap:10px;margin-top:16px}
.join-code-input input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(173,247,245,0.2);border-radius:8px;padding:14px 16px;font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:8px;color:var(--yellow);text-transform:uppercase;outline:none;transition:border-color 0.2s;text-align:center}
.join-code-input input:focus{border-color:rgba(173,247,245,0.5)}

/* Announcement panels on results screen */
.announce-banner{background:linear-gradient(135deg,rgba(173,247,245,0.08),rgba(233,150,245,0.08));border:1px solid rgba(173,247,245,0.2);border-radius:12px;padding:20px 24px;margin-bottom:20px;text-align:center}
.announce-banner h3{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:var(--mint);margin-bottom:4px}
.announce-banner p{font-size:13px;color:rgba(255,255,255,0.6);letter-spacing:0.5px}

/* Export modal table */
.export-options{display:flex;flex-direction:column;gap:12px}
.export-option{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border:1px solid rgba(13,115,119,0.15);border-radius:12px;cursor:pointer;transition:all 0.2s}
.export-option:hover{background:rgba(13,115,119,0.05);border-color:rgba(13,115,119,0.3)}
.export-option-label{font-size:13px;font-weight:600;color:var(--dark)}
.export-option-desc{font-size:11px;color:var(--gray);margin-top:2px}
.export-badge{background:var(--teal);color:white;font-size:9px;letter-spacing:2px;font-weight:700;padding:3px 10px;border-radius:20px;font-family:'Josefin Sans',sans-serif;text-transform:uppercase}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<!-- ─── SWEEP REVEAL OVERLAY ─────────────────────────────────────── -->
<div class="sweep-reveal" id="sweepReveal"></div>

<!-- ─── TOAST CONTAINER ──────────────────────────────────────────── -->
<div class="toast-container" id="toastContainer"></div>

<!-- ─── NAV ─────────────────────────────────────────────────────── -->
<nav class="nav" id="mainNav">
  <div class="nav-badge" onclick="goHome()">
    <span class="the">THE</span>
    <span class="res">RESONANCE</span>
    <span class="game">GAME</span>
  </div>
  <div class="nav-right">
    <span class="nav-session-code" id="navCode"></span>
    <span class="nav-phase-badge" id="navPhase"></span>
  </div>
</nav>

<!-- ─── MODALS ────────────────────────────────────────────────────── -->

<!-- New Game Modal -->
<div class="modal-backdrop" id="modalNewGame">
  <div class="modal">
    <div class="modal-title">New Game?</div>
    <div class="modal-body">What would you like to do?</div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="startFreshGame()">Start Fresh</button>
      <button class="btn btn-outline" onclick="backToLobby()">Back to Lobby</button>
      <button class="btn btn-secondary" style="background:transparent;color:var(--gray);border-color:rgba(136,136,136,0.3)" onclick="closeModal('modalNewGame')">Cancel</button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-backdrop" id="modalExport">
  <div class="modal">
    <div class="modal-title">Export Results</div>
    <div class="modal-body">Choose your export format:</div>
    <div class="export-options">
      <div class="export-option" onclick="exportCSVRaw()">
        <div>
          <div class="export-option-label">Raw Votes CSV</div>
          <div class="export-option-desc">statement_id, text, submitter, voter_id, value, round</div>
        </div>
        <div class="export-badge">CSV</div>
      </div>
      <div class="export-option" onclick="exportCSVAgg()">
        <div>
          <div class="export-option-label">Aggregated Results CSV</div>
          <div class="export-option-desc">avg_score, vote_count, std_dev per statement</div>
        </div>
        <div class="export-badge">CSV</div>
      </div>
      <div class="export-option" onclick="exportPDF()">
        <div>
          <div class="export-option-label">PDF Summary Report</div>
          <div class="export-option-desc">Logo header, session metadata, all leaderboards</div>
        </div>
        <div class="export-badge">PDF</div>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn btn-secondary" onclick="closeModal('modalExport')">Close</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div class="modal-backdrop" id="modalConfirm">
  <div class="modal">
    <div class="modal-title" id="confirmTitle">Confirm</div>
    <div class="modal-body" id="confirmBody">Are you sure?</div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="confirmOk" onclick="">Yes, proceed</button>
      <button class="btn btn-secondary" onclick="closeModal('modalConfirm')">Cancel</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 1 — LANDING
════════════════════════════════════════════════════════════════ -->
<div class="view active dark-hero" id="view-landing">
  <!-- Decorative sun rays -->
  <div class="sun-wrap">
    <svg viewBox="0 0 640 640" fill="none">
      <g transform="translate(320,320)">
        <g stroke="rgba(173,247,245,0.1)" stroke-width="1">
          <line x1="0" y1="-310" x2="0" y2="-145"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(15)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(30)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(45)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(60)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(75)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(90)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(105)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(120)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(135)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(150)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(165)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(180)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(195)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(210)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(225)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(240)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(255)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(270)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(285)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(300)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(315)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(330)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(345)"/>
        </g>
        <circle cx="0" cy="0" r="140" stroke="rgba(173,247,245,0.07)" stroke-width="1" fill="none"/>
        <circle cx="0" cy="0" r="160" stroke="rgba(233,150,245,0.06)" stroke-width="1" fill="none"/>
        <circle cx="0" cy="0" r="200" stroke="rgba(173,247,245,0.04)" stroke-width="1" fill="none"/>
      </g>
    </svg>
  </div>
  <div class="stripe-band"><div style="background:var(--mint)"></div><div style="background:var(--pink)"></div><div style="background:var(--lavender)"></div><div style="background:var(--yellow)"></div><div style="background:var(--offwhite)"></div></div>
  <div class="title-hero">
    <div class="hero-eyebrow">Group Intelligence Platform</div>
    <div class="hero-title">RESONANCE</div>
    <div class="hero-sub">THE GAME</div>
    <div class="hero-tagline">Find what moves your group — and what divides it</div>
  </div>
  <div class="title-cols">
    <!-- Host a game -->
    <div class="card" style="animation:fadeUp 0.7s 0.4s ease both">
      <div class="card-inner">
        <div class="section-label">Host a Session</div>
        <p style="color:rgba(255,255,255,0.55);font-size:14px;line-height:1.7;margin-bottom:28px">Create a new Resonance Game session. Set up rounds, timers, and share a unique code with your group.</p>
        <button class="btn btn-primary" style="width:100%;padding:18px;font-size:15px;letter-spacing:4px" onclick="showView('view-create')">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 2v14M2 9h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Create Session
        </button>
      </div>
    </div>
    <!-- Join a game -->
    <div class="join-panel" style="animation:fadeUp 0.7s 0.5s ease both">
      <div class="section-label">Join a Session</div>
      <p style="color:rgba(255,255,255,0.55);font-size:14px;line-height:1.7;margin-bottom:4px">Enter the session code shared by your host.</p>
      <div class="join-code-input">
        <input type="text" id="joinCodeInput" placeholder="ABC123" maxlength="8" oninput="this.value=this.value.toUpperCase()">
        <button class="btn btn-primary" onclick="joinFromLanding()" style="padding:14px 22px;font-size:12px;letter-spacing:2px">Join</button>
      </div>
      <div style="margin-top:16px">
        <input type="text" class="form-input" id="joinNameInput" placeholder="Your name" maxlength="30">
      </div>
      <p class="form-hint" style="margin-top:6px">2–30 characters. Must be unique within the session.</p>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 2 — CREATE GAME
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-create">
  <div class="sun-wrap" style="opacity:0.5">
    <svg viewBox="0 0 640 640" fill="none"><g transform="translate(320,320)"><circle cx="0" cy="0" r="200" stroke="rgba(173,247,245,0.08)" stroke-width="1" fill="none"/><circle cx="0" cy="0" r="280" stroke="rgba(233,150,245,0.05)" stroke-width="1" fill="none"/></g></svg>
  </div>
  <div class="create-container">
    <div class="create-title">CREATE<br>SESSION</div>
    <div class="create-sub">Set up your Resonance Game</div>

    <div class="form-group">
      <label class="form-label">Session Title *</label>
      <input type="text" class="form-input" id="cf-title" placeholder="e.g. Team Day — Q3 Retro" maxlength="80" oninput="updatePreview()">
    </div>
    <div class="form-group">
      <label class="form-label">Custom Session Code (optional)</label>
      <input type="text" class="form-input" id="cf-code" placeholder="e.g. TEAMDAY" maxlength="8" oninput="checkCode(this.value)" style="text-transform:uppercase;letter-spacing:4px;font-family:'Bebas Neue',sans-serif;font-size:22px">
      <div id="codeStatus" class="code-status"></div>
      <p class="form-hint">4–8 alphanumeric characters. Leave blank to auto-generate.</p>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Statements per participant</label>
        <select class="form-input" id="cf-stmts">
          <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Maximum rounds</label>
        <select class="form-input" id="cf-rounds">
          <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Submission timer</label>
        <select class="form-input" id="cf-sub-timer">
          <option value="0">Off</option><option value="120">2 minutes</option><option value="300" selected>5 minutes</option><option value="600">10 minutes</option><option value="custom">Custom…</option>
        </select>
        <input type="number" class="form-input" id="cf-sub-timer-custom" placeholder="Minutes" min="1" style="display:none;margin-top:8px" oninput="this.value=Math.max(1,parseInt(this.value)||1)">
      </div>
      <div class="form-group">
        <label class="form-label">Voting timer</label>
        <select class="form-input" id="cf-vote-timer">
          <option value="0">Off</option><option value="120">2 minutes</option><option value="300" selected>5 minutes</option><option value="600">10 minutes</option><option value="custom">Custom…</option>
        </select>
        <input type="number" class="form-input" id="cf-vote-timer-custom" placeholder="Minutes" min="1" style="display:none;margin-top:8px" oninput="this.value=Math.max(1,parseInt(this.value)||1)">
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:12px">
      <button class="btn btn-primary" onclick="createSession()" style="flex:1;padding:18px;font-size:14px;letter-spacing:4px">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M4 9l4 4 6-8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Launch Session
      </button>
      <button class="btn btn-secondary" onclick="showView('view-landing')">Cancel</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 3 — HOST PANEL (LOBBY)
════════════════════════════════════════════════════════════════ -->
<div class="view dark-hero" id="view-host-lobby">
  <div class="sun-wrap">
    <svg viewBox="0 0 640 640" fill="none"><g transform="translate(320,320)"><g stroke="rgba(173,247,245,0.07)" stroke-width="1"><line x1="0" y1="-310" x2="0" y2="-145"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(30)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(60)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(90)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(120)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(150)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(180)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(210)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(240)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(270)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(300)"/><line x1="0" y1="-310" x2="0" y2="-145" transform="rotate(330)"/></g><circle cx="0" cy="0" r="140" stroke="rgba(173,247,245,0.07)" stroke-width="1" fill="none"/></g></svg>
  </div>
  <div class="stripe-band"><div style="background:var(--mint)"></div><div style="background:var(--pink)"></div><div style="background:var(--lavender)"></div><div style="background:var(--yellow)"></div><div style="background:var(--offwhite)"></div></div>
  <div style="max-width:1100px;margin:0 auto;padding:60px 32px 80px;position:relative;z-index:2">
    <div style="text-align:center;margin-bottom:48px">
      <div class="hero-eyebrow" id="lobbySessionTitle">Session Title</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:clamp(48px,8vw,100px);letter-spacing:5px;line-height:0.92;background:linear-gradient(135deg,var(--mint) 0%,white 45%,var(--pink) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">RESONANCE</div>
      <div style="font-family:'Playfair Display',serif;font-style:italic;font-size:17px;color:rgba(255,255,255,0.45);margin-top:12px">Waiting for participants to join…</div>
    </div>
    <div class="title-cols" style="padding:0">
      <!-- QR + share -->
      <div class="card" style="animation:fadeUp 0.6s 0.2s ease both">
        <div class="card-inner">
          <div class="section-label">Join the Game</div>
          <div class="qr-box" id="qrContainer">
            <!-- QR placeholder SVG -->
            <div id="qrCanvas" width="140" height="140"></canvas>
          </div>
          <div class="join-url-row">
            <div class="join-url" id="joinUrlDisplay">resonance.game/join/——</div>
            <button class="copy-btn" onclick="copyJoinLink()">COPY</button>
          </div>
          <div style="margin-top:20px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <span style="font-size:10px;letter-spacing:3px;color:var(--gray);text-transform:uppercase">Session Code</span>
              <span class="session-code-val" id="lobbyCode">——</span>
            </div>
            <div style="font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:1px"><span id="lobbyRoundInfo">1</span> round · <span id="lobbyStmtsPerP">3</span> statements/participant</div>
          </div>
        </div>
      </div>
      <!-- Participants -->
      <div class="card" style="animation:fadeUp 0.6s 0.3s ease both">
        <div class="card-inner">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
            <div class="section-label" style="margin-bottom:0">Participants</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--pink)" id="lobbyParticipantCount">0 joined</div>
          </div>
          <div class="participant-list" id="lobbyParticipantList" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow-y:auto">
            <div style="font-size:13px;color:rgba(255,255,255,0.3);text-align:center;padding:20px;font-family:'Playfair Display',serif;font-style:italic">Waiting for participants to join…</div>
          </div>
          <div style="margin-top:24px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <span style="font-size:11px;letter-spacing:2px;color:rgba(255,255,255,0.5)">Submitted</span>
              <span class="host-pct-label" id="lobbySubmitPct">0%</span>
            </div>
            <div class="host-progress-bar"><div class="host-progress-fill" id="lobbySubmitBar" style="width:0%"></div></div>
            <p style="font-size:10px;color:rgba(255,255,255,0.3);letter-spacing:1px;margin-top:6px">Start enabled at ≥50% submitted</p>
          </div>
          <div style="margin-top:20px;display:flex;flex-direction:column;gap:10px">
            <button class="btn btn-primary" id="startRoundBtn" onclick="hostStartRound()" style="width:100%;padding:16px;font-size:14px;letter-spacing:4px" disabled>
              START RESONANCE ROUND
            </button>
            <button class="btn btn-secondary" onclick="hostForceStart()" style="font-size:10px;letter-spacing:2px">
              Force Start Submissions (0 joined)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 4 — HOST SUBMISSION PHASE
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-host-submission" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="display:flex;align-items:center;gap:16px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;color:white" id="hsubTitle">—</div>
      <div class="phase-badge submitting">● Submission Phase</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="hsubTimer" class="timer-display" style="display:none">5:00</div>
      <button class="extend-btn" id="hsubExtendBtn" onclick="hostExtendTimer('sub')" style="display:none">+1 MIN</button>
    </div>
  </div>
  <div style="max-width:780px;margin:0 auto;padding:40px 32px 80px">
    <div style="background:white;border-radius:16px;padding:28px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06);margin-bottom:24px">
      <div class="section-label dark">Submission Progress</div>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <div style="flex:1">
          <div class="host-progress-bar" style="background:rgba(13,115,119,0.12)"><div class="host-progress-fill" id="hsubProgressBar" style="width:0%;background:var(--teal)"></div></div>
        </div>
        <div class="host-pct-label" style="color:var(--teal)" id="hsubPctLabel">0 / 0 submitted (0%)</div>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn btn-teal" id="hsubStartVoteBtn" onclick="hostStartVoting()" disabled style="font-size:11px;letter-spacing:3px">
          START VOTING ROUND
        </button>
        <button class="btn btn-outline" onclick="hostForceEndSubmissions()" style="font-size:10px;letter-spacing:2px">
          Force End Submissions
        </button>
      </div>
    </div>
    <!-- Live participant submission status -->
    <div style="background:white;border-radius:16px;padding:28px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06)">
      <div class="section-label dark">Participants</div>
      <div id="hsubParticipantStatus" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 5 — HOST VOTING PHASE
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-host-voting" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="display:flex;align-items:center;gap:16px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;color:white" id="hvoteTitle">—</div>
      <div class="phase-badge voting">● Voting Phase</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="hvoteTimer" class="timer-display" style="display:none">5:00</div>
      <button class="extend-btn" id="hvoteExtendBtn" onclick="hostExtendTimer('vote')" style="display:none">+1 MIN</button>
    </div>
  </div>
  <div style="max-width:780px;margin:0 auto;padding:40px 32px 80px">
    <div style="background:white;border-radius:16px;padding:28px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06);margin-bottom:24px">
      <div class="section-label dark">Voting Progress</div>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <div style="flex:1">
          <div class="host-progress-bar" style="background:rgba(13,115,119,0.12)"><div class="host-progress-fill" id="hvoteProgressBar" style="width:0%;background:var(--magenta)"></div></div>
        </div>
        <div class="host-pct-label" style="color:var(--magenta)" id="hvotePctLabel">0 / 0 voted (0%)</div>
      </div>
      <div style="font-size:11px;color:var(--gray);letter-spacing:1px;margin-bottom:16px" id="hvoteTotalStmts">0 total statements</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn btn-teal" id="hvoteShowResultsBtn" onclick="hostShowResults()" disabled style="font-size:11px;letter-spacing:3px">
          SHOW RESULTS
        </button>
      </div>
    </div>
    <div style="background:white;border-radius:16px;padding:28px;box-shadow:0 2px 16px rgba(13,115,119,0.07);border:1px solid rgba(13,115,119,0.06)">
      <div class="section-label dark">Voting Status</div>
      <div id="hvoteParticipantStatus" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 6 — PARTICIPANT: WAITING ROOM
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-waiting" style="background:var(--offwhite);padding-top:64px">
  <div class="waiting-screen">
    <div class="waiting-icon">⏳</div>
    <div class="waiting-title" id="waitingTitle">WAITING</div>
    <div class="waiting-sub" id="waitingSub">Waiting for host to start the session…</div>
    <div style="width:100%;max-width:360px">
      <div class="waiting-progress"><div class="waiting-progress-fill" id="waitingProgressFill" style="width:0%"></div></div>
      <div class="waiting-pct" id="waitingProgressLabel">0%</div>
      <div style="font-size:11px;color:var(--gray);letter-spacing:1px;margin-top:4px" id="waitingProgressSub">of participants ready</div>
    </div>
    <div style="margin-top:32px;font-size:11px;letter-spacing:2px;color:var(--gray)">Session: <span id="waitingSessionCode" style="color:var(--teal);font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:4px">——</span></div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 7 — PARTICIPANT: SUBMISSION PHASE
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-submission" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="background:white;border:2px solid var(--dark);border-radius:6px;padding:3px 8px;box-shadow:2px 2px 0 var(--dark);display:flex;flex-direction:column;align-items:center;line-height:1">
        <span style="font-size:6px;font-weight:700;letter-spacing:3px;color:var(--magenta)">THE</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:var(--dark)">RESONANCE</span>
        <span style="font-size:5px;font-weight:300;letter-spacing:4px;color:var(--teal);border-top:1px solid var(--dark);padding-top:1px">GAME</span>
      </div>
      <span style="font-family:'Righteous',sans-serif;font-size:13px;color:rgba(255,255,255,0.8);letter-spacing:1px" id="subSessionName">—</span>
    </div>
    <div id="subTimerWrap" style="display:flex;align-items:center;gap:8px;display:none">
      <div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.5);text-transform:uppercase">Time</div>
      <div class="timer-display" id="subTimer">5:00</div>
    </div>
  </div>
  <div class="light-content" style="padding-top:40px">
    <div class="section-label dark" id="subPhaseLabel" style="text-align:center">SUBMISSION PHASE</div>
    <!-- Statement Card -->
    <div class="card-stack-wrap" id="subCardWrap">
      <div class="statement-card ghost-card ghost-card-2"></div>
      <div class="statement-card ghost-card ghost-card-1"></div>
      <div class="statement-card active-card" id="subActiveCard">
        <span class="statement-number" id="subCardNum">1 of 3</span>
        <textarea class="statement-textarea" id="subTextarea" placeholder="Type your statement here…" maxlength="280" oninput="updateCharCount()"></textarea>
        <div class="char-counter" id="charCounter">0 / 280</div>
      </div>
    </div>
    <div class="card-nav">
      <button class="nav-arrow back" id="subBackBtn" onclick="subPrev()">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Back
      </button>
      <button class="nav-arrow next" id="subNextBtn" onclick="subNext()">
        Next
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 8 — PARTICIPANT: REVIEW STATEMENTS
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-review-statements" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="font-family:'Righteous',sans-serif;font-size:16px;color:white;letter-spacing:1px">Review Your Statements</div>
    <div style="font-size:11px;letter-spacing:2px;color:rgba(255,255,255,0.6)">Edit before submitting</div>
  </div>
  <div class="light-content" style="padding-top:40px">
    <div class="review-list" id="reviewStatementsList"></div>
    <button class="btn btn-teal" onclick="submitStatements()" style="width:100%;padding:18px;font-size:14px;letter-spacing:4px">
      SUBMIT ALL
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 8h8M9 5l3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="btn btn-secondary" onclick="showView('view-submission')" style="width:100%;margin-top:10px;font-size:10px;letter-spacing:2px">Edit Statements</button>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 9 — PARTICIPANT: VOTING PHASE
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-voting" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="background:white;border:2px solid var(--dark);border-radius:6px;padding:3px 8px;box-shadow:2px 2px 0 var(--dark);display:flex;flex-direction:column;align-items:center;line-height:1">
        <span style="font-size:6px;font-weight:700;letter-spacing:3px;color:var(--magenta)">THE</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:var(--dark)">RESONANCE</span>
        <span style="font-size:5px;font-weight:300;letter-spacing:4px;color:var(--teal);border-top:1px solid var(--dark);padding-top:1px">GAME</span>
      </div>
      <span style="font-family:'Righteous',sans-serif;font-size:13px;color:rgba(255,255,255,0.8);letter-spacing:1px" id="voteSessionName">—</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px" id="voteTimerWrap">
      <div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.5);text-transform:uppercase">Time</div>
      <div class="timer-display" id="voteTimer">5:00</div>
    </div>
  </div>
  <div class="light-content" style="padding-top:32px">
    <!-- Card stack -->
    <div class="card-stack-wrap" id="voteCardWrap">
      <div class="statement-card ghost-card ghost-card-2"></div>
      <div class="statement-card ghost-card ghost-card-1"></div>
      <div class="statement-card active-card" id="voteActiveCard">
        <span class="statement-number" id="voteCardNum">1 of 9</span>
        <div class="statement-text" id="voteStmtText">"Loading statement…"</div>
        <div class="statement-author" id="voteStmtAuthor">— —</div>
      </div>
    </div>
    <!-- Voting buttons -->
    <div class="vote-section">
      <div class="vote-label-row">
        <span class="vote-label">Totally Distant</span>
        <span class="vote-label">Totally Resonant</span>
      </div>
      <div class="vote-buttons">
        <button class="vote-btn v1" onclick="castVote(this,1)"><span class="vnum">1</span></button>
        <button class="vote-btn v2" onclick="castVote(this,2)"><span class="vnum">2</span></button>
        <button class="vote-btn v3" onclick="castVote(this,3)"><span class="vnum">3</span></button>
        <button class="vote-btn v4" onclick="castVote(this,4)"><span class="vnum">4</span></button>
        <button class="vote-btn v5" onclick="castVote(this,5)"><span class="vnum">5</span></button>
      </div>
      <div class="card-nav" style="margin-top:8px">
        <button class="nav-arrow back" onclick="votePrev()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Back
        </button>
        <button class="nav-arrow next" onclick="voteNext()" id="voteNextBtn">
          Skip
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </div>
  <!-- Fixed progress dock -->
  <div class="progress-dock">
    <div class="progress-row">
      <div class="progress-label">YOU</div>
      <div class="progress-bar-bg" style="flex:1"><div class="progress-bar-fill" id="myVoteBar" style="width:0%;background:var(--teal)"></div></div>
      <div class="progress-pct" id="myVotePct">0/0</div>
    </div>
    <div class="progress-row" style="margin-bottom:0">
      <div class="progress-label">GROUP</div>
      <div class="progress-bar-bg" style="flex:1"><div class="progress-bar-fill" id="groupVoteBar" style="width:0%;background:var(--magenta)"></div></div>
      <div class="progress-pct" id="groupVotePct">0%</div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 10 — PARTICIPANT: REVIEW VOTES
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-review-votes" style="background:var(--offwhite)">
  <div class="light-header" style="padding-top:78px">
    <div style="font-family:'Righteous',sans-serif;font-size:16px;color:white;letter-spacing:1px">Review Your Votes</div>
    <div style="font-size:11px;letter-spacing:2px;color:rgba(255,255,255,0.6)">Change before submitting</div>
  </div>
  <div class="light-content" style="padding-top:40px">
    <div class="review-list" id="reviewVotesList"></div>
    <button class="btn btn-teal" onclick="submitVotes()" style="width:100%;padding:18px;font-size:14px;letter-spacing:4px">
      SUBMIT VOTES
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 8h8M9 5l3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="btn btn-secondary" onclick="showView('view-voting');renderVoteCard()" style="width:100%;margin-top:10px;font-size:10px;letter-spacing:2px">Continue Voting</button>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     VIEW 11 — RESULTS
════════════════════════════════════════════════════════════════ -->
<div class="view" id="view-results">
  <div class="results-hero">
    <div style="position:relative">
      <div class="results-title" id="resultsSessionTitle">RESULTS</div>
      <div class="results-meta" id="resultsMeta">—</div>
    </div>
    <div class="results-stripe" style="margin-top:28px"><div style="background:var(--mint)"></div><div style="background:var(--pink)"></div><div style="background:var(--lavender)"></div><div style="background:var(--yellow)"></div></div>
  </div>
  <div class="tabs-bar">
    <button class="tab-btn active" onclick="showTab('resonance',this)">🌊 Resonance</button>
    <button class="tab-btn" onclick="showTab('dissonance',this)">🔻 Dissonance</button>
    <button class="tab-btn" onclick="showTab('variability',this)">⚡ Variability</button>
    <button class="tab-btn" onclick="showTab('people',this)">👥 People</button>
  </div>
  <div class="results-body">
    <!-- Resonance Tab -->
    <div class="tab-panel active" id="tab-resonance">
      <div class="leaderboard" id="lb-resonance"></div>
      <div class="scatter-chart-wrap" style="margin-top:32px">
        <div style="font-family:'Righteous',sans-serif;font-size:14px;letter-spacing:1px;color:var(--dark);margin-bottom:8px">Resonance Map — Score vs. Variability</div>
        <div style="font-size:11px;color:var(--gray);letter-spacing:0.5px;margin-bottom:12px">Hover dots to see statements</div>
        <div class="scatter-area" id="scatterArea"></div>
        <div class="scatter-labels">
          <span>Totally Distant (1)</span>
          <span>Average Score →</span>
          <span>Totally Resonant (5)</span>
        </div>
      </div>
    </div>
    <!-- Dissonance Tab -->
    <div class="tab-panel" id="tab-dissonance">
      <div class="leaderboard" id="lb-dissonance"></div>
    </div>
    <!-- Variability Tab -->
    <div class="tab-panel" id="tab-variability">
      <div class="leaderboard" id="lb-variability"></div>
    </div>
    <!-- People Tab -->
    <div class="tab-panel" id="tab-people">
      <div class="people-toggle">
        <button class="toggle-btn active" onclick="showPeopleView('resonant',this)">Most Resonant</button>
        <button class="toggle-btn" onclick="showPeopleView('divisive',this)">Most Divisive</button>
      </div>
      <div id="people-resonant"></div>
      <div id="people-divisive" style="display:none"></div>
    </div>
  </div>
  <!-- Host floating action buttons -->
  <div class="host-fab" id="hostFab" style="display:none">
    <button class="host-btn export" onclick="openModal('modalExport')">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1v8M4 6l3 3 3-3M2 11h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      Export
    </button>
    <button class="host-btn add-round" id="addRoundBtn" onclick="hostAddRound()">+ Add Round</button>
    <button class="host-btn new-game" onclick="openModal('modalNewGame')">New Game</button>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
════════════════════════════════════════════════════════════════ -->
<script>
'use strict';

// ─── SUPABASE CLIENT ──────────────────────────────────────────────────────────
// Load the Supabase JS library from CDN (no build step required for this file)
// IMPORTANT: Replace the two placeholder values below with your real credentials
// from Supabase → Settings → API before deploying.
const SUPABASE_URL  = 'https://meaknroswawuflwtzjei.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lYWtucm9zd2F3dWZsd3R6amVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjI3NjIsImV4cCI6MjA4NzUzODc2Mn0.TqZbug33tRegVM5IEL5lr3dGNe2oHk__T4-Y4vcEwoo';

// ─── CONSTANTS ────────────────────────────────────────────────────────────────
const AVATAR_COLORS      = ['#ADF7F5','#E996F5','#C6C6F5','#F4F597','#0D7377','#8B1A8B','#14919B','#F4A261'];
const AVATAR_TEXT_COLORS = ['#0D7377','#1A1A2E','#1A1A2E','#1A1A2E','#fff','#fff','#fff','#fff'];

// ─── STATE ────────────────────────────────────────────────────────────────────
// G holds only in-memory UI state — no session data lives here anymore.
// All persistent state lives in Supabase. G.currentSession is a plain object
// fetched from the DB and kept in sync by Realtime subscriptions.
let G = {
  currentCode:         null,
  currentSession:      null,  // sessions row
  isHost:              false,
  myParticipantId:     null,
  myName:              null,
  // Submission phase (client-only drafts)
  draftStatements:     [],
  subCurrentIdx:       0,
  // Voting phase
  shuffledStatements:  [],
  voteCurrentIdx:      0,
  myVotes:             {},     // statementId -> value (1-5)
  // Cached DB rows (refreshed by realtime)
  participants:        [],
  statements:          [],
  votes:               [],
  // Timers
  timerInterval:       null,
  timerSecondsRemaining: 0,
  // Active Supabase Realtime channels (kept so we can unsubscribe cleanly)
  channels:            [],
};

// ─── SUPABASE BOOTSTRAP ───────────────────────────────────────────────────────
// The Supabase JS v2 library is loaded via a <script> tag injected below.
// We defer all DB calls until it confirms it's ready.
let sb = null;  // will be set once the SDK loads

function initSupabase() {
  if (typeof window.supabase === 'undefined') {
    setTimeout(initSupabase, 50);
    return;
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // If a session was previously active (e.g. page refresh), try to resume it
  resumeSession();
}

// ─── SESSION RESUME ON REFRESH ────────────────────────────────────────────────
async function resumeSession() {
  const code        = sessionStorage.getItem('rg_code');
  const participantId = sessionStorage.getItem('rg_participant_id');
  const hostToken   = sessionStorage.getItem('rg_host_token');
  if (!code || !participantId) return;

  try {
    const { data: session } = await sb.from('sessions').select('*').eq('code', code).single();
    if (!session) { sessionStorage.clear(); return; }

    G.currentCode        = code;
    G.currentSession     = session;
    G.myParticipantId    = participantId;
    G.isHost             = !!hostToken;

    const { data: me } = await sb.from('participants').select('*').eq('id', participantId).single();
    if (me) G.myName = me.display_name;

    updateNavCode(code);
    if (G.isHost) {
      await refreshParticipants();
      await refreshStatements();
      await refreshVotes();
      routeHostToPhase(session.status);
    } else {
      routeParticipantToPhase(session.status);
    }
  } catch(e) {
    // Session gone or expired — start fresh
    sessionStorage.clear();
  }
}

// ─── REALTIME: SUBSCRIBE ──────────────────────────────────────────────────────
// All subscriptions funnel through here so we can cleanly unsubscribe on
// navigation (goHome, startFreshGame, etc.)
function subscribeToSession(sessionId) {
  unsubscribeAll();

  // sessions UPDATE → phase changes (host advancing rounds/phases)
  const sessionCh = sb.channel(`session-${sessionId}`)
    .on('postgres_changes', {
      event: 'UPDATE', schema: 'public', table: 'sessions',
      filter: `id=eq.${sessionId}`,
    }, async (payload) => {
      const newStatus = payload.new.status;
      const oldStatus = G.currentSession ? G.currentSession.status : null;
      G.currentSession = payload.new;

      if (G.isHost) {
        await refreshParticipants();
        await refreshStatements();
        await refreshVotes();
        if (newStatus !== oldStatus) routeHostToPhase(newStatus);
      } else {
        if (newStatus !== oldStatus) {
          if (newStatus === 'results') {
            triggerSweepReveal(() => {
              routeParticipantToPhase(newStatus);
            });
          } else {
            routeParticipantToPhase(newStatus);
          }
        }
      }
    })
    .subscribe();

  // participants INSERT/UPDATE → lobby list, submission/vote counts
  const participantCh = sb.channel(`participants-${sessionId}`)
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'participants',
      filter: `session_id=eq.${sessionId}`,
    }, async () => {
      await refreshParticipants();
      const view = currentActiveView();
      if (view === 'view-host-lobby')      updateLobbyParticipantList();
      if (view === 'view-host-submission') updateHostSubmissionView();
      if (view === 'view-host-voting')     updateHostVotingView();
      if (view === 'view-waiting')         updateWaitingProgress(G._waitingPhase);
    })
    .subscribe();

  // statements INSERT → submission progress bars
  const stmtCh = sb.channel(`statements-${sessionId}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'statements',
      filter: `session_id=eq.${sessionId}`,
    }, async (payload) => {
      G.statements.push(payload.new);
      const view = currentActiveView();
      if (view === 'view-host-submission') updateHostSubmissionView();
      if (view === 'view-waiting')         updateWaitingProgress(G._waitingPhase);
    })
    .subscribe();

  // votes INSERT → voting progress bars
  const voteCh = sb.channel(`votes-${sessionId}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'votes',
      filter: `session_id=eq.${sessionId}`,
    }, async (payload) => {
      G.votes.push(payload.new);
      const view = currentActiveView();
      if (view === 'view-host-voting') updateHostVotingView();
      if (view === 'view-waiting')     updateWaitingProgress(G._waitingPhase);
    })
    .subscribe();

  G.channels = [sessionCh, participantCh, stmtCh, voteCh];
}

function unsubscribeAll() {
  G.channels.forEach(ch => { try { sb.removeChannel(ch); } catch(e) {} });
  G.channels = [];
}

// ─── DATA REFRESH HELPERS ─────────────────────────────────────────────────────
async function refreshParticipants() {
  const { data } = await sb.from('participants')
    .select('*').eq('session_id', G.currentSession.id).order('joined_at');
  G.participants = data || [];
}

async function refreshStatements() {
  const { data } = await sb.from('statements')
    .select('*, participants(display_name)')
    .eq('session_id', G.currentSession.id)
    .order('submitted_at');
  // Flatten submitter_name for convenience
  G.statements = (data || []).map(s => ({
    ...s,
    submitter_name: s.participants?.display_name || 'Unknown',
  }));
}

async function refreshVotes() {
  const { data } = await sb.from('votes')
    .select('*').eq('session_id', G.currentSession.id);
  G.votes = data || [];
}

async function refreshScores() {
  const { data } = await sb.from('statement_scores')
    .select('*').eq('session_id', G.currentSession.id);
  return data || [];
}

// ─── ROUTER HELPERS ───────────────────────────────────────────────────────────
function currentActiveView() {
  const el = document.querySelector('.view.active');
  return el ? el.id : null;
}

function routeHostToPhase(status) {
  switch(status) {
    case 'lobby':       loadHostLobby();          break;
    case 'submitting':  loadHostSubmissionView();  break;
    case 'voting':      loadHostVotingView();      break;
    case 'results':     loadResultsView(true);     break;
  }
}

function routeParticipantToPhase(status) {
  switch(status) {
    case 'lobby':       loadParticipantWaiting('lobby');     break;
    case 'submitting':  loadParticipantSubmission();         break;
    case 'voting':      loadParticipantVoting();             break;
    case 'results':     loadResultsView(false);              break;
  }
}

// ─── VIEW SYSTEM ──────────────────────────────────────────────────────────────
function showView(id, skipScroll) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) {
    el.classList.add('active');
    if (!skipScroll) window.scrollTo({top:0,behavior:'smooth'});
  }
}

function goHome() {
  unsubscribeAll();
  clearTimers();
  G.currentCode = null;
  G.currentSession = null;
  G.isHost = false;
  G.myParticipantId = null;
  G.myName = null;
  G.participants = [];
  G.statements = [];
  G.votes = [];
  sessionStorage.clear();
  updateNavCode(null);
  setNavPhase('');
  showView('view-landing');
}

// ─── TOAST ────────────────────────────────────────────────────────────────────
function toast(msg, type='success', duration=3000) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => {
    t.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => t.remove(), 300);
  }, duration);
}

// ─── MODALS ───────────────────────────────────────────────────────────────────
function openModal(id)  { document.getElementById(id).classList.add('active') }
function closeModal(id) { document.getElementById(id).classList.remove('active') }

// ─── NAV ──────────────────────────────────────────────────────────────────────
function updateNavCode(code) {
  const el = document.getElementById('navCode');
  if (code) { el.textContent = code; el.style.display = 'block'; }
  else       { el.style.display = 'none'; }
}
function setNavPhase(label) { document.getElementById('navPhase').textContent = label; }

// ─── SWEEP REVEAL ─────────────────────────────────────────────────────────────
function triggerSweepReveal(onComplete) {
  const sweep = document.getElementById('sweepReveal');
  sweep.classList.add('active');
  setTimeout(() => {
    sweep.classList.remove('active');
    if (onComplete) onComplete();
  }, 900);
}

// ─── CODE GENERATOR ───────────────────────────────────────────────────────────
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

// ─── CODE AVAILABILITY CHECK (live DB query) ──────────────────────────────────
let codeCheckTimer;
async function checkCode(val) {
  val = val.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
  document.getElementById('cf-code').value = val;
  clearTimeout(codeCheckTimer);
  const status = document.getElementById('codeStatus');
  if (!val)           { status.innerHTML = ''; return; }
  if (val.length < 4) { status.innerHTML = '<span class="code-err">⚠ 4–8 characters required</span>'; return; }
  status.innerHTML = '<span style="color:rgba(255,255,255,0.4)">Checking…</span>';
  codeCheckTimer = setTimeout(async () => {
    try {
      const { data } = await sb.from('sessions').select('code').eq('code', val).maybeSingle();
      if (data) status.innerHTML = '<span class="code-err">✗ Code taken</span>';
      else      status.innerHTML = '<span class="code-ok">✓ Available</span>';
    } catch(e) {
      status.innerHTML = '<span class="code-err">Could not check — check connection</span>';
    }
  }, 400);
}

// ─── CREATE SESSION ───────────────────────────────────────────────────────────
async function createSession() {
  const title = document.getElementById('cf-title').value.trim();
  if (!title) { toast('Session title is required', 'error'); return; }

  let code = document.getElementById('cf-code').value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  if (code && (code.length < 4 || code.length > 8)) {
    toast('Code must be 4–8 characters', 'error'); return;
  }

  // If no custom code, generate a unique one
  if (!code) {
    let attempts = 0;
    while (attempts < 10) {
      code = genCode();
      const { data } = await sb.from('sessions').select('code').eq('code', code).maybeSingle();
      if (!data) break;
      attempts++;
    }
  } else {
    // Validate custom code is not taken
    const { data: taken } = await sb.from('sessions').select('code').eq('code', code).maybeSingle();
    if (taken) { toast('Code already taken', 'error'); return; }
  }

  const stmtsPerP  = parseInt(document.getElementById('cf-stmts').value);
  const maxRounds  = parseInt(document.getElementById('cf-rounds').value);
  const subTimerVal  = document.getElementById('cf-sub-timer').value;
  const voteTimerVal = document.getElementById('cf-vote-timer').value;
  const subSecs  = subTimerVal  === 'custom' ? parseInt(document.getElementById('cf-sub-timer-custom').value  || 5) * 60 : parseInt(subTimerVal)  || null;
  const voteSecs = voteTimerVal === 'custom' ? parseInt(document.getElementById('cf-vote-timer-custom').value || 5) * 60 : parseInt(voteTimerVal) || null;

  const hostToken = crypto.randomUUID();

  // Disable button to prevent double-submit
  const btn = document.querySelector('#view-create .btn-primary');
  btn.disabled = true;
  btn.textContent = 'Creating…';

  try {
    // 1. Insert session row
    const { data: session, error: sessionErr } = await sb
      .from('sessions')
      .insert({
        code,
        title,
        host_token: hostToken,
        status: 'lobby',
        current_round: 1,
        max_rounds: maxRounds,
        statements_per_participant: stmtsPerP,
        submission_timer_seconds: subSecs || null,
        voting_timer_seconds: voteSecs || null,
        phase_started_at: null,
      })
      .select()
      .single();

    if (sessionErr) throw sessionErr;

    // 2. Insert host as participant
    const { data: hostParticipant, error: pErr } = await sb
      .from('participants')
      .insert({ session_id: session.id, display_name: 'Host', is_host: true })
      .select()
      .single();

    if (pErr) throw pErr;

    // 3. Store credentials
    sessionStorage.setItem('rg_code',           session.code);
    sessionStorage.setItem('rg_host_token',     hostToken);
    sessionStorage.setItem('rg_participant_id', hostParticipant.id);

    G.currentCode      = session.code;
    G.currentSession   = session;
    G.isHost           = true;
    G.myParticipantId  = hostParticipant.id;
    G.myName           = 'Host';
    G.participants     = [hostParticipant];

    updateNavCode(session.code);
    setNavPhase('● LOBBY');
    subscribeToSession(session.id);
    loadHostLobby();

  } catch(e) {
    console.error(e);
    toast('Error creating session: ' + (e.message || e), 'error', 5000);
    btn.disabled = false;
    btn.textContent = 'Launch Session';
  }
}

// ─── HOST LOBBY ───────────────────────────────────────────────────────────────
function loadHostLobby() {
  const s = G.currentSession;
  document.getElementById('lobbySessionTitle').textContent = s.title.toUpperCase();
  document.getElementById('lobbyCode').textContent = s.code;
  document.getElementById('lobbyRoundInfo').textContent = s.max_rounds + (s.max_rounds === 1 ? ' round' : ' rounds');
  document.getElementById('lobbyStmtsPerP').textContent = s.statements_per_participant;
  document.getElementById('joinUrlDisplay').textContent = window.location.origin + '?join=' + s.code;
  drawQRCode(s.code);
  updateLobbyParticipantList();
  showView('view-host-lobby');
  setNavPhase('● LOBBY');
}

function updateLobbyParticipantList() {
  const participants = G.participants.filter(p => !p.is_host);
  const list = document.getElementById('lobbyParticipantList');
  document.getElementById('lobbyParticipantCount').textContent = participants.length + ' joined';

  if (participants.length === 0) {
    list.innerHTML = '<div style="font-size:13px;color:rgba(255,255,255,0.3);text-align:center;padding:20px;font-family:\'Playfair Display\',serif;font-style:italic">Waiting for participants to join…</div>';
  } else {
    list.innerHTML = participants.map((p, i) => {
      const color     = AVATAR_COLORS[i % AVATAR_COLORS.length];
      const textColor = AVATAR_TEXT_COLORS[i % AVATAR_TEXT_COLORS.length];
      return `
        <div class="participant-item" style="animation-delay:${i * 0.05}s">
          <div class="p-avatar" style="background:${color};color:${textColor}">${p.display_name[0].toUpperCase()}</div>
          <div><div class="p-name">${p.display_name}</div><div class="p-joined">joined</div></div>
          <div class="p-status"><div class="dot-pulse"></div></div>
        </div>`;
    }).join('');
  }

  // Submission % derived from statements table (unique submitter_ids)
  const currentRoundStmts = G.statements.filter(s => s.round === G.currentSession.current_round);
  const uniqueSubmitters  = new Set(currentRoundStmts.map(s => s.submitter_id)).size;
  const total             = participants.length;
  const pct               = total > 0 ? Math.round(uniqueSubmitters / total * 100) : 0;

  document.getElementById('lobbySubmitPct').textContent    = pct + '%';
  document.getElementById('lobbySubmitBar').style.width    = pct + '%';

  const startBtn = document.getElementById('startRoundBtn');
  startBtn.disabled   = pct < 50 && total > 0;
  startBtn.textContent = `START RESONANCE ROUND${total > 0 ? ' (' + pct + '% ready)' : ''}`;

  const forceBtn = document.querySelector('#view-host-lobby .btn-secondary');
  if (forceBtn) forceBtn.textContent = `Force Start Submissions (${total} joined)`;
}

// ─── QR CODE (decorative canvas pattern seeded from session code) ─────────────
function drawQRCode(code) {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas) return;
  canvas.innerHTML = '';
  const url = window.location.origin + '?join=' + code;
  new QRCode(canvas, {
    text: url,
    width: 140,
    height: 140,
    colorDark: '#1A1A2E',
    colorLight: '#ffffff',
  });
}

// ─── HOST: START ROUND ────────────────────────────────────────────────────────
async function hostStartRound() {
  const s = G.currentSession;
  try {
    const { error } = await sb.from('sessions').update({
      status: 'submitting',
      phase_started_at: new Date().toISOString(),
    }).eq('id', s.id).eq('host_token', sessionStorage.getItem('rg_host_token'));
    if (error) throw error;
    // Realtime will update G.currentSession and call routeHostToPhase
  } catch(e) {
    toast('Error starting round: ' + e.message, 'error');
  }
}

async function hostForceStart() {
  await hostStartRound();
}

// ─── HOST: SUBMISSION VIEW ────────────────────────────────────────────────────
function loadHostSubmissionView() {
  const s = G.currentSession;
  document.getElementById('hsubTitle').textContent = s.title.toUpperCase();

  if (s.submission_timer_seconds) {
    const elapsed = s.phase_started_at
      ? Math.floor((Date.now() - new Date(s.phase_started_at).getTime()) / 1000)
      : 0;
    const remaining = Math.max(0, s.submission_timer_seconds - elapsed);
    document.getElementById('hsubTimer').style.display   = 'block';
    document.getElementById('hsubExtendBtn').style.display = 'block';
    startCountdown(remaining, 'hsubTimer', () => toast('⏰ Submission time is up!', 'error', 4000));
  }

  updateHostSubmissionView();
  showView('view-host-submission');
  setNavPhase('● SUBMISSION');
}

function updateHostSubmissionView() {
  const participants  = G.participants.filter(p => !p.is_host);
  const round         = G.currentSession.current_round;
  const roundStmts    = G.statements.filter(s => s.round === round);
  const submitterIds  = new Set(roundStmts.map(s => s.submitter_id));
  const submitted     = participants.filter(p => submitterIds.has(p.id)).length;
  const total         = participants.length;
  const pct           = total > 0 ? Math.round(submitted / total * 100) : 0;

  document.getElementById('hsubProgressBar').style.width    = pct + '%';
  document.getElementById('hsubPctLabel').textContent       = `${submitted} / ${total} submitted (${pct}%)`;
  document.getElementById('hsubStartVoteBtn').disabled      = submitted === 0;

  document.getElementById('hsubParticipantStatus').innerHTML = participants.map((p, i) => {
    const color     = AVATAR_COLORS[i % AVATAR_COLORS.length];
    const textColor = AVATAR_TEXT_COLORS[i % AVATAR_TEXT_COLORS.length];
    const hasSub    = submitterIds.has(p.id);
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;
        background:${hasSub ? 'rgba(173,247,245,0.08)' : 'rgba(0,0,0,0.03)'};
        border:1px solid ${hasSub ? 'rgba(173,247,245,0.2)' : 'rgba(0,0,0,0.06)'}">
        <div style="width:28px;height:28px;border-radius:50%;background:${color};color:${textColor};
          display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:13px;flex-shrink:0">${p.display_name[0]}</div>
        <div style="font-size:13px;font-weight:600;color:var(--dark)">${p.display_name}</div>
        <div style="margin-left:auto;font-size:11px;letter-spacing:1px;color:${hasSub ? 'var(--teal)' : 'var(--gray)'};font-weight:700">
          ${hasSub ? '✓ SUBMITTED' : 'Writing…'}
        </div>
      </div>`;
  }).join('');
}

// ─── HOST: START VOTING ───────────────────────────────────────────────────────
async function hostStartVoting() {
  try {
    const { error } = await sb.from('sessions').update({
      status: 'voting',
      phase_started_at: new Date().toISOString(),
    }).eq('id', G.currentSession.id).eq('host_token', sessionStorage.getItem('rg_host_token'));
    if (error) throw error;
  } catch(e) {
    toast('Error starting voting: ' + e.message, 'error');
  }
}

async function hostForceEndSubmissions() {
  await hostStartVoting();
}

// ─── HOST: VOTING VIEW ────────────────────────────────────────────────────────
function loadHostVotingView() {
  const s = G.currentSession;
  document.getElementById('hvoteTitle').textContent = s.title.toUpperCase();

  const roundStmts = G.statements.filter(st => st.round === s.current_round);
  document.getElementById('hvoteTotalStmts').textContent = roundStmts.length + ' statements to vote on';

  if (s.voting_timer_seconds) {
    const elapsed   = s.phase_started_at ? Math.floor((Date.now() - new Date(s.phase_started_at).getTime()) / 1000) : 0;
    const remaining = Math.max(0, s.voting_timer_seconds - elapsed);
    document.getElementById('hvoteTimer').style.display    = 'block';
    document.getElementById('hvoteExtendBtn').style.display = 'block';
    startCountdown(remaining, 'hvoteTimer', () => toast('⏰ Voting time is up!', 'error', 4000));
  }

  updateHostVotingView();
  showView('view-host-voting');
  setNavPhase('● VOTING');
}

function updateHostVotingView() {
  const participants  = G.participants.filter(p => !p.is_host);
  const round         = G.currentSession.current_round;
  const roundStmts    = G.statements.filter(s => s.round === round);
  const roundVotes    = G.votes.filter(v => v.round === round);

  // A participant has "voted" when they have a vote for every statement
  const votedIds = new Set(
    participants
      .filter(p => {
        const theirVotes = roundVotes.filter(v => v.voter_id === p.id);
        return theirVotes.length >= roundStmts.length && roundStmts.length > 0;
      })
      .map(p => p.id)
  );

  const voted = votedIds.size;
  const total = participants.length;
  const pct   = total > 0 ? Math.round(voted / total * 100) : 0;

  document.getElementById('hvoteProgressBar').style.width  = pct + '%';
  document.getElementById('hvotePctLabel').textContent     = `${voted} / ${total} voted (${pct}%)`;
  document.getElementById('hvoteShowResultsBtn').disabled  = voted === 0;

  document.getElementById('hvoteParticipantStatus').innerHTML = participants.map((p, i) => {
    const color      = AVATAR_COLORS[i % AVATAR_COLORS.length];
    const textColor  = AVATAR_TEXT_COLORS[i % AVATAR_TEXT_COLORS.length];
    const hasVoted   = votedIds.has(p.id);
    const voteCount  = roundVotes.filter(v => v.voter_id === p.id).length;
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;
        background:${hasVoted ? 'rgba(233,150,245,0.08)' : 'rgba(0,0,0,0.03)'};
        border:1px solid ${hasVoted ? 'rgba(233,150,245,0.2)' : 'rgba(0,0,0,0.06)'}">
        <div style="width:28px;height:28px;border-radius:50%;background:${color};color:${textColor};
          display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:13px;flex-shrink:0">${p.display_name[0]}</div>
        <div style="font-size:13px;font-weight:600;color:var(--dark)">${p.display_name}</div>
        <div style="margin-left:auto;font-size:11px;letter-spacing:1px;color:${hasVoted ? 'var(--magenta)' : 'var(--gray)'};font-weight:700">
          ${hasVoted ? '✓ VOTED' : voteCount + '/' + roundStmts.length + ' voted'}
        </div>
      </div>`;
  }).join('');
}

// ─── HOST: SHOW RESULTS ───────────────────────────────────────────────────────
async function hostShowResults() {
  try {
    const { error } = await sb.from('sessions').update({
      status: 'results',
    }).eq('id', G.currentSession.id).eq('host_token', sessionStorage.getItem('rg_host_token'));
    if (error) throw error;
    // Realtime triggers sweep + results on all clients simultaneously.
    // Host also gets the update through their own subscription.
    triggerSweepReveal(() => loadResultsView(true));
  } catch(e) {
    toast('Error showing results: ' + e.message, 'error');
  }
}

// ─── HOST: EXTEND TIMER ───────────────────────────────────────────────────────
function hostExtendTimer(phase) {
  G.timerSecondsRemaining += 60;
  toast('+1 minute added', 'success');
}

// ─── PARTICIPANT: JOIN ────────────────────────────────────────────────────────
async function joinFromLanding() {
  const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
  const name = document.getElementById('joinNameInput').value.trim();

  if (!code)            { toast('Enter a session code', 'error');               return; }
  if (name.length < 2)  { toast('Name must be at least 2 characters', 'error'); return; }
  if (name.length > 30) { toast('Name must be 30 characters or less', 'error'); return; }

  const joinBtn = document.querySelector('#view-landing .btn-primary');
  joinBtn.disabled   = true;
  joinBtn.textContent = 'Joining…';

  try {
    // 1. Look up session
    const { data: session, error: sErr } = await sb
      .from('sessions').select('*').eq('code', code).maybeSingle();
    if (!session) { toast('Session not found. Check the code.', 'error'); return; }
    if (session.status === 'results') { toast('This session has ended.', 'error'); return; }

    // 2. Insert participant (DB UNIQUE constraint handles name collision)
    let displayName = name;
    let attempts    = 0;
    let participant = null;
    while (attempts < 5) {
      const { data: p, error: pErr } = await sb
        .from('participants')
        .insert({ session_id: session.id, display_name: displayName, is_host: false })
        .select().single();
      if (!pErr) { participant = p; break; }
      if (pErr.code === '23505') {
        attempts++;
        displayName = name + ' ' + (attempts + 1);
        if (attempts === 1) toast(`"${name}" is taken, trying "${displayName}"`, 'success', 2000);
      } else {
        throw pErr;
      }
    }
    if (!participant) throw new Error('Could not create unique participant name');

    // 3. Set state
    sessionStorage.setItem('rg_code',           session.code);
    sessionStorage.setItem('rg_participant_id', participant.id);

    G.currentCode     = session.code;
    G.currentSession  = session;
    G.isHost          = false;
    G.myParticipantId = participant.id;
    G.myName          = participant.display_name;
    G.draftStatements = new Array(session.statements_per_participant).fill('');
    G.subCurrentIdx   = 0;

    await refreshParticipants();
    await refreshStatements();

    updateNavCode(session.code);
    subscribeToSession(session.id);
    routeParticipantToPhase(session.status);

  } catch(e) {
    console.error(e);
    toast('Error joining: ' + (e.message || e), 'error', 5000);
  } finally {
    joinBtn.disabled    = false;
    joinBtn.textContent = 'Join';
  }
}

// ─── PARTICIPANT: WAITING ROOM ────────────────────────────────────────────────
// Store current waiting phase so Realtime handlers can call updateWaitingProgress
G._waitingPhase = 'lobby';

function loadParticipantWaiting(phase) {
  G._waitingPhase = phase;
  const s = G.currentSession;
  document.getElementById('waitingSessionCode').textContent = s.code;

  if (phase === 'lobby') {
    document.getElementById('waitingTitle').textContent     = 'WELCOME';
    document.getElementById('waitingSub').textContent       = `Hey ${G.myName}! Waiting for host to start…`;
    document.getElementById('waitingProgressSub').textContent = 'participants joined';
  } else if (phase === 'submitted') {
    document.getElementById('waitingTitle').textContent     = 'SUBMITTED';
    document.getElementById('waitingSub').textContent       = 'Your statements are in! Waiting for others…';
    document.getElementById('waitingProgressSub').textContent = 'have submitted';
  } else if (phase === 'voted') {
    document.getElementById('waitingTitle').textContent     = 'VOTES IN';
    document.getElementById('waitingSub').textContent       = 'Waiting for the host to reveal results…';
    document.getElementById('waitingProgressSub').textContent = 'have voted';
  }

  updateWaitingProgress(phase);
  showView('view-waiting');
  setNavPhase('● WAITING');
  // No polling — Realtime subscription on sessions handles phase transitions
}

function updateWaitingProgress(phase) {
  const participants = G.participants.filter(p => !p.is_host);
  const total        = participants.length;
  const round        = G.currentSession ? G.currentSession.current_round : 1;
  let done           = 0;

  if (phase === 'lobby') {
    done = total;
  } else if (phase === 'submitted') {
    const submitters = new Set(
      G.statements.filter(s => s.round === round).map(s => s.submitter_id)
    );
    done = participants.filter(p => submitters.has(p.id)).length;
  } else if (phase === 'voted') {
    const roundStmts = G.statements.filter(s => s.round === round);
    done = participants.filter(p => {
      const theirVotes = G.votes.filter(v => v.voter_id === p.id && v.round === round);
      return theirVotes.length >= roundStmts.length && roundStmts.length > 0;
    }).length;
  }

  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('waitingProgressFill').style.width = pct + '%';
  document.getElementById('waitingProgressLabel').textContent = done + ' / ' + total;
}

// ─── PARTICIPANT: SUBMISSION PHASE ────────────────────────────────────────────
function loadParticipantSubmission() {
  const s = G.currentSession;
  document.getElementById('subSessionName').textContent = s.title;

  if (s.submission_timer_seconds) {
    const elapsed   = s.phase_started_at ? Math.floor((Date.now() - new Date(s.phase_started_at).getTime()) / 1000) : 0;
    const remaining = Math.max(0, s.submission_timer_seconds - elapsed);
    document.getElementById('subTimerWrap').style.display = 'flex';
    startCountdown(remaining, 'subTimer', () => {
      toast('⏰ Time is up! Auto-submitting…', 'error', 4000);
      submitStatements(true);
    });
  }

  G.subCurrentIdx = 0;
  renderSubCard();
  showView('view-submission');
  setNavPhase('● SUBMISSION');
}

function renderSubCard() {
  const s     = G.currentSession;
  const n     = G.subCurrentIdx;
  const total = s.statements_per_participant;

  document.getElementById('subCardNum').textContent    = (n + 1) + ' of ' + total;
  document.getElementById('subPhaseLabel').textContent = 'ROUND ' + s.current_round + ' — STATEMENT ' + (n + 1) + ' OF ' + total;
  document.getElementById('subTextarea').value         = G.draftStatements[n] || '';
  updateCharCount();

  document.getElementById('subBackBtn').classList.toggle('disabled', n === 0);
  const nextBtn = document.getElementById('subNextBtn');
  if (n === total - 1) {
    nextBtn.innerHTML = 'Review All <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  } else {
    nextBtn.innerHTML = 'Next <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  }

  const card = document.getElementById('subActiveCard');
  card.style.transition = 'none';
  card.style.transform  = 'translateX(40px)';
  card.style.opacity    = '0';
  requestAnimationFrame(() => {
    setTimeout(() => {
      card.style.transition = 'all 0.35s cubic-bezier(0.34,1.56,0.64,1)';
      card.style.transform  = 'translateX(0)';
      card.style.opacity    = '1';
    }, 20);
  });
}

function updateCharCount() {
  const len = document.getElementById('subTextarea').value.length;
  const counter = document.getElementById('charCounter');
  counter.textContent = len + ' / 280';
  counter.classList.toggle('warn', len > 260);
  G.draftStatements[G.subCurrentIdx] = document.getElementById('subTextarea').value;
}

function subPrev() {
  if (G.subCurrentIdx > 0) {
    G.draftStatements[G.subCurrentIdx] = document.getElementById('subTextarea').value;
    G.subCurrentIdx--;
    renderSubCard();
  }
}

function subNext() {
  G.draftStatements[G.subCurrentIdx] = document.getElementById('subTextarea').value;
  const s = G.currentSession;
  if (G.subCurrentIdx < s.statements_per_participant - 1) {
    G.subCurrentIdx++;
    renderSubCard();
  } else {
    loadReviewStatements();
  }
}

function loadReviewStatements() {
  G.draftStatements[G.subCurrentIdx] = document.getElementById('subTextarea').value;
  document.getElementById('reviewStatementsList').innerHTML = G.draftStatements.map((text, i) => `
    <div class="review-item">
      <div class="review-num">Statement ${i + 1}</div>
      <div class="review-text">${text
        ? '"' + escapeHtml(text) + '"'
        : '<span style="color:var(--gray);font-style:italic">Empty — will be skipped</span>'
      }</div>
      <button class="review-edit" onclick="editStatement(${i})">Edit</button>
    </div>`).join('');
  showView('view-review-statements');
}

function editStatement(idx) {
  G.subCurrentIdx = idx;
  showView('view-submission');
  renderSubCard();
}

async function submitStatements(auto = false) {
  const s    = G.currentSession;
  const rows = G.draftStatements
    .filter(text => text && text.trim())
    .map(text => ({
      session_id:   s.id,
      round:        s.current_round,
      submitter_id: G.myParticipantId,
      text:         '"' + text.trim() + '"',
    }));

  if (rows.length === 0 && !auto) {
    toast('Write at least one statement', 'error'); return;
  }

  try {
    if (rows.length > 0) {
      const { error } = await sb.from('statements').insert(rows);
      if (error) throw error;
    }
    clearTimers();
    toast('Statements submitted! ✓', 'success');
    // Optimistically update local cache so waiting screen shows immediately
    rows.forEach(r => G.statements.push({ ...r, id: 'pending', submitter_name: G.myName, submitted_at: new Date().toISOString() }));
    loadParticipantWaiting('submitted');
  } catch(e) {
    toast('Error submitting: ' + e.message, 'error');
  }
}

// ─── PARTICIPANT: VOTING PHASE ────────────────────────────────────────────────
async function loadParticipantVoting() {
  const s = G.currentSession;
  document.getElementById('voteSessionName').textContent = s.title;

  // Fetch fresh statements for this round
  await refreshStatements();
  const stmts = G.statements.filter(st => st.round === s.current_round);

  // Fisher-Yates shuffle seeded by participant UUID (deterministic on refresh)
  G.shuffledStatements = fisherYatesShuffle([...stmts], G.myParticipantId);
  G.voteCurrentIdx     = 0;
  G.myVotes            = {};

  if (s.voting_timer_seconds) {
    const elapsed   = s.phase_started_at ? Math.floor((Date.now() - new Date(s.phase_started_at).getTime()) / 1000) : 0;
    const remaining = Math.max(0, s.voting_timer_seconds - elapsed);
    document.getElementById('voteTimerWrap').style.display = 'flex';
    startCountdown(remaining, 'voteTimer', () => {
      toast('⏰ Time is up!', 'error', 4000);
      goToReviewVotes();
    });
  }

  renderVoteCard();
  showView('view-voting');
  setNavPhase('● VOTING');
}

function fisherYatesShuffle(arr, seed) {
  let s = 0;
  for (const c of seed) s = (s * 31 + c.charCodeAt(0)) >>> 0;
  function rand() { s = (s * 1664525 + 1013904223) >>> 0; return s / 0xFFFFFFFF; }
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function renderVoteCard() {
  const stmts = G.shuffledStatements;
  const idx   = G.voteCurrentIdx;

  if (idx >= stmts.length) { goToReviewVotes(); return; }

  const stmt = stmts[idx];
  document.getElementById('voteCardNum').textContent   = (idx + 1) + ' of ' + stmts.length;
  document.getElementById('voteStmtText').textContent  = stmt.text;
  document.getElementById('voteStmtAuthor').textContent = '— ' + stmt.submitter_name;

  document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
  if (G.myVotes[stmt.id]) {
    document.querySelectorAll('.vote-btn')[G.myVotes[stmt.id] - 1].classList.add('selected');
  }

  // Update progress bars
  const voted   = Object.keys(G.myVotes).length;
  const total   = stmts.length;
  const myPct   = Math.round(voted / total * 100);
  document.getElementById('myVoteBar').style.width  = myPct + '%';
  document.getElementById('myVotePct').textContent  = voted + '/' + total;

  const participants  = G.participants.filter(p => !p.is_host);
  const round         = G.currentSession.current_round;
  const roundVotes    = G.votes.filter(v => v.round === round);
  const groupVoted    = participants.filter(p => {
    return roundVotes.filter(v => v.voter_id === p.id).length >= stmts.length && stmts.length > 0;
  }).length;
  const groupPct      = participants.length > 0 ? Math.round(groupVoted / participants.length * 100) : 0;
  document.getElementById('groupVoteBar').style.width = groupPct + '%';
  document.getElementById('groupVotePct').textContent  = groupPct + '%';

  const nextBtn = document.getElementById('voteNextBtn');
  if (idx === stmts.length - 1) {
    nextBtn.innerHTML = 'Review <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  } else {
    nextBtn.innerHTML = 'Skip <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  }

  const card = document.getElementById('voteActiveCard');
  card.style.transition = 'none';
  card.style.transform  = 'translateX(40px)';
  card.style.opacity    = '0';
  requestAnimationFrame(() => {
    setTimeout(() => {
      card.style.transition = 'all 0.35s cubic-bezier(0.34,1.56,0.64,1)';
      card.style.transform  = 'translateX(0)';
      card.style.opacity    = '1';
    }, 20);
  });
}

function castVote(btn, val) {
  const stmt        = G.shuffledStatements[G.voteCurrentIdx];
  G.myVotes[stmt.id] = val;

  document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  btn.style.transform = 'translateY(-6px) scale(1.25)';
  setTimeout(() => {
    btn.style.transform = '';
    setTimeout(() => {
      G.voteCurrentIdx++;
      if (G.voteCurrentIdx >= G.shuffledStatements.length) goToReviewVotes();
      else renderVoteCard();
    }, 220);
  }, 180);
}

function votePrev() {
  if (G.voteCurrentIdx > 0) { G.voteCurrentIdx--; renderVoteCard(); }
}

function voteNext() {
  G.voteCurrentIdx++;
  if (G.voteCurrentIdx >= G.shuffledStatements.length) goToReviewVotes();
  else renderVoteCard();
}

function goToReviewVotes() {
  const stmts = G.shuffledStatements;
  const VOTE_LABELS = ['', 'Totally Distant', 'Distant', 'Neutral', 'Resonant', 'Totally Resonant'];
  const VOTE_COLORS = ['', '#E996F5', '#C6C6F5', '#ccc', '#ADF7F5', '#0D7377'];

  document.getElementById('reviewVotesList').innerHTML = stmts.map((stmt, i) => {
    const v = G.myVotes[stmt.id];
    return `
      <div class="review-item" onclick="jumpToVote(${i})" style="cursor:pointer">
        <div class="review-num">Statement ${i + 1}</div>
        <div class="review-text">${stmt.text}</div>
        <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
          ${v
            ? `<div style="width:28px;height:28px;border-radius:50%;background:${VOTE_COLORS[v]};
                 display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;
                 font-size:15px;color:${v === 5 ? 'white' : 'var(--dark)'};border:2px solid rgba(0,0,0,0.1)">${v}</div>
               <span style="font-size:11px;letter-spacing:1px;color:var(--gray);text-transform:uppercase;font-weight:700">${VOTE_LABELS[v]}</span>`
            : `<span style="font-size:11px;letter-spacing:1px;color:#ff6b6b;font-weight:700">NOT VOTED — tap to vote</span>`
          }
        </div>
      </div>`;
  }).join('');
  showView('view-review-votes');
}

function jumpToVote(idx) {
  G.voteCurrentIdx = idx;
  showView('view-voting');
  renderVoteCard();
}

async function submitVotes() {
  const unvoted = G.shuffledStatements.filter(st => !G.myVotes[st.id]);
  if (unvoted.length > 0) {
    toast(`${unvoted.length} statement${unvoted.length > 1 ? 's' : ''} unvoted — vote all to submit`, 'error'); return;
  }

  const rows = Object.entries(G.myVotes).map(([stmtId, val]) => ({
    statement_id: stmtId,
    session_id:   G.currentSession.id,
    voter_id:     G.myParticipantId,
    value:        val,
    round:        G.currentSession.current_round,
  }));

  try {
    const { error } = await sb.from('votes').upsert(rows, { onConflict: 'statement_id,voter_id' });
    if (error) throw error;
    clearTimers();
    toast('Votes submitted! ✓', 'success');
    // Optimistically update local cache
    rows.forEach(r => {
      const exists = G.votes.find(v => v.statement_id === r.statement_id && v.voter_id === r.voter_id);
      if (!exists) G.votes.push({ ...r, id: 'pending' });
    });
    loadParticipantWaiting('voted');
  } catch(e) {
    toast('Error submitting votes: ' + e.message, 'error');
  }
}

// ─── RESULTS ──────────────────────────────────────────────────────────────────
async function loadResultsView(isHost) {
  const s = G.currentSession;
  document.getElementById('resultsSessionTitle').textContent = s.title.toUpperCase();

  const participants = G.participants.filter(p => !p.is_host);
  const scored       = await refreshScores();

  document.getElementById('resultsMeta').textContent =
    `${participants.length} participants · ${scored.length} statements · Round ${s.current_round} of ${s.max_rounds}`;

  renderResonanceTab(scored);
  renderDissonanceTab(scored);
  renderVariabilityTab(scored);
  renderPeopleTab(scored, participants);
  renderScatterChart(scored);

  document.getElementById('hostFab').style.display = isHost ? 'flex' : 'none';
  if (isHost) {
    const addBtn = document.getElementById('addRoundBtn');
    addBtn.disabled   = s.current_round >= s.max_rounds;
    addBtn.textContent = s.current_round >= s.max_rounds ? 'Max Rounds' : '+ Add Round';
  }

  showView('view-results');
  setNavPhase('● RESULTS');
  setTimeout(animateBars, 400);
}

function computeScoresLocal(stmts, votes) {
  return stmts.map(stmt => {
    const vals    = votes.filter(v => v.statement_id === stmt.id).map(v => v.value);
    const avg     = vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
    const mean    = avg;
    const variance = vals.length > 1 ? vals.reduce((a, b) => a + (b - mean) ** 2, 0) / (vals.length - 1) : 0;
    return {
      ...stmt,
      resonance_score:   Math.round(avg * 10) / 10,
      variability_score: Math.round(Math.sqrt(variance) * 100) / 100,
      vote_count:        vals.length,
    };
  });
}

function rankClass(i) {
  return i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
}

function renderLeaderboard(containerId, items, barColor) {
  const el = document.getElementById(containerId);
  if (!items || items.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:40px;font-family:\'Playfair Display\',serif;font-style:italic;color:var(--gray)">No data yet</div>';
    return;
  }
  el.innerHTML = items.map((item, i) => `
    <div class="lb-row" style="animation-delay:${i * 0.06}s">
      <div class="lb-rank ${rankClass(i)}">${i + 1}</div>
      <div class="lb-content">
        <div class="lb-statement">${escapeHtml(item.text)}</div>
        <div class="lb-meta">
          <span class="lb-author">${escapeHtml(item.submitter_name || '')}</span>
          ${item.round > 1 ? `<span class="round-badge">● Round ${item.round}</span>` : ''}
        </div>
        <div class="lb-bar-wrap">
          <div class="lb-bar-bg">
            <div class="lb-bar-fill" style="background:${barColor};width:${(parseFloat(item.resonance_score) / 5 * 100)}%"></div>
          </div>
        </div>
      </div>
      <div class="lb-score-col">
        <div class="lb-score-num">${parseFloat(item.resonance_score || 0).toFixed(1)}</div>
        <div class="lb-score-denom">/ 5</div>
        <div class="lb-votes">${item.vote_count} votes</div>
      </div>
    </div>`).join('');
}

function renderResonanceTab(scored) {
  const sorted = [...scored].sort((a, b) => b.resonance_score - a.resonance_score);
  renderLeaderboard('lb-resonance', sorted, 'var(--mint)');
}

function renderDissonanceTab(scored) {
  const sorted = [...scored].sort((a, b) => a.resonance_score - b.resonance_score);
  // Use pink bar for dissonance — override bar width to use resonance_score
  const el = document.getElementById('lb-dissonance');
  if (!sorted || sorted.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:40px;font-family:\'Playfair Display\',serif;font-style:italic;color:var(--gray)">No data yet</div>';
    return;
  }
  el.innerHTML = sorted.map((item, i) => `
    <div class="lb-row" style="animation-delay:${i * 0.06}s">
      <div class="lb-rank ${rankClass(i)}">${i + 1}</div>
      <div class="lb-content">
        <div class="lb-statement">${escapeHtml(item.text)}</div>
        <div class="lb-meta">
          <span class="lb-author">${escapeHtml(item.submitter_name || '')}</span>
          ${item.round > 1 ? `<span class="round-badge">● Round ${item.round}</span>` : ''}
        </div>
        <div class="lb-bar-wrap">
          <div class="lb-bar-bg">
            <div class="lb-bar-fill" style="background:var(--pink);width:${((5 - parseFloat(item.resonance_score)) / 4 * 100)}%"></div>
          </div>
        </div>
      </div>
      <div class="lb-score-col">
        <div class="lb-score-num" style="color:var(--magenta)">${parseFloat(item.resonance_score || 0).toFixed(1)}</div>
        <div class="lb-score-denom">/ 5</div>
        <div class="lb-votes">${item.vote_count} votes</div>
      </div>
    </div>`).join('');
}

function renderVariabilityTab(scored) {
  const sorted = [...scored].sort((a, b) => b.variability_score - a.variability_score);
  const el = document.getElementById('lb-variability');
  if (!sorted || sorted.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:40px;font-family:\'Playfair Display\',serif;font-style:italic;color:var(--gray)">No data yet</div>';
    return;
  }
  const maxStd = Math.max(...sorted.map(s => parseFloat(s.variability_score || 0)), 0.1);
  el.innerHTML = sorted.map((item, i) => `
    <div class="lb-row" style="animation-delay:${i * 0.06}s">
      <div class="lb-rank ${rankClass(i)}">${i + 1}</div>
      <div class="lb-content">
        <div class="lb-statement">${escapeHtml(item.text)}</div>
        <div class="lb-meta">
          <span class="lb-author">${escapeHtml(item.submitter_name || '')}</span>
          ${item.round > 1 ? `<span class="round-badge">● Round ${item.round}</span>` : ''}
        </div>
        <div class="lb-bar-wrap">
          <div class="lb-bar-bg">
            <div class="lb-bar-fill" style="background:var(--yellow);width:${(parseFloat(item.variability_score) / maxStd * 100)}%"></div>
          </div>
        </div>
      </div>
      <div class="lb-score-col">
        <div class="lb-score-num" style="color:var(--dark);font-size:20px">σ ${parseFloat(item.variability_score || 0).toFixed(2)}</div>
        <div class="lb-votes">${item.vote_count} votes</div>
      </div>
    </div>`).join('');
}

function renderPeopleTab(scored, participants) {
  const bySubmitter = {};
  scored.forEach(s => {
    const id = s.submitter_id;
    if (!bySubmitter[id]) bySubmitter[id] = { name: s.submitter_name, stmts: [] };
    bySubmitter[id].stmts.push(s);
  });

  const submitters = Object.values(bySubmitter).map((s, i) => ({
    name:           s.name,
    avgResonance:   s.stmts.reduce((a, b) => a + parseFloat(b.resonance_score || 0), 0) / s.stmts.length,
    avgVariability: s.stmts.reduce((a, b) => a + parseFloat(b.variability_score || 0), 0) / s.stmts.length,
    color:          AVATAR_COLORS[i % AVATAR_COLORS.length],
    textColor:      AVATAR_TEXT_COLORS[i % AVATAR_TEXT_COLORS.length],
    stmtCount:      s.stmts.length,
  }));

  function renderList(arr, metric) {
    if (!arr.length) return '<div style="text-align:center;padding:40px;color:var(--gray);font-family:\'Playfair Display\',serif;font-style:italic">No data yet</div>';
    return arr.map((s, i) => `
      <div class="people-row" style="animation-delay:${i * 0.07}s">
        <div class="people-avatar" style="background:${s.color};color:${s.textColor}">${s.name[0]}</div>
        <div>
          <div class="people-name">${escapeHtml(s.name)}</div>
          <div class="people-stat">${s.stmtCount} statement${s.stmtCount !== 1 ? 's' : ''} · avg ${metric === 'res' ? s.avgResonance.toFixed(1) + ' resonance' : s.avgVariability.toFixed(2) + ' variability'}</div>
        </div>
        <div class="people-score">${metric === 'res' ? s.avgResonance.toFixed(1) : s.avgVariability.toFixed(2)}</div>
      </div>`).join('');
  }

  const byRes = [...submitters].sort((a, b) => b.avgResonance - a.avgResonance);
  const byDiv = [...submitters].sort((a, b) => b.avgVariability - a.avgVariability);
  document.getElementById('people-resonant').innerHTML = renderList(byRes, 'res');
  document.getElementById('people-divisive').innerHTML = renderList(byDiv, 'div');
}

function renderScatterChart(scored) {
  const el = document.getElementById('scatterArea');
  if (!el || scored.length === 0) return;
  const maxStd = Math.max(...scored.map(s => parseFloat(s.variability_score || 0)), 2);
  el.innerHTML = scored.map(s => {
    const avg  = parseFloat(s.resonance_score || 0);
    const std  = parseFloat(s.variability_score || 0);
    const x    = ((avg - 1) / 4) * 90 + 5;
    const y    = (1 - (std / maxStd)) * 85 + 5;
    const size = Math.min(18 + (s.vote_count * 1.5), 36);
    const color = avg >= 4 ? 'var(--teal)' : avg >= 3 ? 'var(--lavender)' : 'var(--pink)';
    const short = s.text.length > 60 ? s.text.substring(0, 60) + '…' : s.text;
    return `
      <div class="scatter-dot" style="left:${x}%;top:${y}%;width:${size}px;height:${size}px;background:${color};transform:translate(-50%,-50%)">
        <span style="font-size:9px;font-weight:700;color:white">${avg.toFixed(1)}</span>
        <div class="scatter-tooltip">${escapeHtml(short)}<br><strong>${avg.toFixed(1)} avg · σ=${std.toFixed(2)}</strong></div>
      </div>`;
  }).join('');
}

function showTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  setTimeout(animateBars, 100);
}

function showPeopleView(view, btn) {
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('people-resonant').style.display = view === 'resonant' ? 'block' : 'none';
  document.getElementById('people-divisive').style.display = view === 'divisive'  ? 'block' : 'none';
}

function animateBars() {
  document.querySelectorAll('.lb-bar-fill').forEach(el => {
    const w = el.style.width;
    el.style.width = '0%';
    setTimeout(() => { el.style.width = w; }, 30);
  });
}

// ─── HOST: ADD ROUND ──────────────────────────────────────────────────────────
async function hostAddRound() {
  const s = G.currentSession;
  if (s.current_round >= s.max_rounds) { toast('Maximum rounds reached', 'error'); return; }
  try {
    const { error } = await sb.from('sessions').update({
      status: 'submitting',
      current_round: s.current_round + 1,
      phase_started_at: new Date().toISOString(),
    }).eq('id', s.id).eq('host_token', sessionStorage.getItem('rg_host_token'));
    if (error) throw error;
    toast(`Round ${s.current_round + 1} started!`, 'success');
    // Realtime update will trigger routeHostToPhase on all clients
  } catch(e) {
    toast('Error adding round: ' + e.message, 'error');
  }
}

async function startFreshGame() {
  closeModal('modalNewGame');
  unsubscribeAll();
  clearTimers();
  G.currentCode     = null;
  G.currentSession  = null;
  G.isHost          = false;
  G.participants    = [];
  G.statements      = [];
  G.votes           = [];
  sessionStorage.clear();
  updateNavCode(null);
  showView('view-create');
}

async function backToLobby() {
  closeModal('modalNewGame');
  try {
    // Reset session to lobby, clear statements and votes for fresh round
    const { error } = await sb.from('sessions')
      .update({ status: 'lobby', current_round: 1 })
      .eq('id', G.currentSession.id)
      .eq('host_token', sessionStorage.getItem('rg_host_token'));
    if (error) throw error;
    // Delete all statements and votes for this session (cascade deletes votes)
    await sb.from('statements').delete().eq('session_id', G.currentSession.id);
    G.statements = [];
    G.votes      = [];
    G.currentSession.status = 'lobby';
    G.currentSession.current_round = 1;
    loadHostLobby();
  } catch(e) {
    toast('Error: ' + e.message, 'error');
  }
}

// ─── EXPORT ───────────────────────────────────────────────────────────────────
async function exportCSVRaw() {
  const { data: votes } = await sb.from('votes').select('*, statements(text, submitter_id, round), participants!voter_id(display_name)').eq('session_id', G.currentSession.id);
  const rows = [['statement_id', 'statement_text', 'submitter_name', 'anon_voter_id', 'vote_value', 'round_number']];
  (votes || []).forEach(v => {
    rows.push([
      v.statement_id,
      (v.statements?.text || '').replace(/,/g, ''),
      '', // submitter name not exposed here per privacy design
      v.voter_id,
      v.value,
      v.round,
    ]);
  });
  downloadCSV(rows, 'resonance-raw-votes.csv');
  closeModal('modalExport');
  toast('Raw votes CSV downloaded', 'success');
}

async function exportCSVAgg() {
  const scored = await refreshScores();
  const rows   = [['statement_text', 'submitter_name', 'avg_score', 'vote_count', 'std_dev', 'round']];
  scored.forEach(s => rows.push([
    s.text.replace(/,/g, ''),
    s.submitter_name || '',
    s.resonance_score,
    s.vote_count,
    s.variability_score,
    s.round,
  ]));
  downloadCSV(rows, 'resonance-aggregates.csv');
  closeModal('modalExport');
  toast('Aggregates CSV downloaded', 'success');
}

function downloadCSV(rows, filename) {
  const csv  = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function exportPDF() {
  closeModal('modalExport');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const s = G.currentSession;

  doc.setFontSize(22);
  doc.setTextColor('#0D7377');
  doc.text('THE RESONANCE GAME', 14, 20);

  doc.setFontSize(12);
  doc.setTextColor('#333333');
  doc.text('Session: ' + s.title, 14, 30);
  doc.text('Code: ' + s.code + '  ·  Round ' + s.current_round, 14, 37);

  const scored = G.statements.map(stmt => {
    const vals = G.votes.filter(v => v.statement_id === stmt.id).map(v => v.value);
    const avg = vals.length > 0 ? (vals.reduce((a,b) => a+b,0)/vals.length).toFixed(2) : '—';
    return [stmt.text.replace(/"/g,''), stmt.submitter_name || '', avg, vals.length];
  }).sort((a,b) => b[2] - a[2]);

  doc.setFontSize(14);
  doc.text('Resonance Rankings', 14, 50);

  let y = 56;
  scored.forEach((row, i) => {
    doc.setFontSize(10);
    doc.setTextColor('#333');
    const text = doc.splitTextToSize((i+1) + '. ' + row[0], 130);
    doc.text(text, 14, y);
    doc.setTextColor('#0D7377');
    doc.text('Score: ' + row[2] + '  Votes: ' + row[3], 155, y);
    doc.setTextColor('#888');
    doc.text(row[1], 155, y + 5);
    y += text.length * 6 + 8;
    if (y > 270) { doc.addPage(); y = 20; }
  });

  doc.save('resonance-' + s.code + '.pdf');
  toast('PDF downloaded', 'success');
}
// ─── TIMER SYSTEM ─────────────────────────────────────────────────────────────
function startCountdown(seconds, elementId, onExpire) {
  clearTimers();
  G.timerSecondsRemaining = seconds;
  function tick() {
    const el = document.getElementById(elementId);
    if (!el) { clearInterval(G.timerInterval); return; }
    const m = Math.floor(G.timerSecondsRemaining / 60);
    const s = G.timerSecondsRemaining % 60;
    el.textContent = m + ':' + String(s).padStart(2, '0');
    el.className   = 'timer-display' + (G.timerSecondsRemaining < 30 ? ' urgent' : '');
    if (G.timerSecondsRemaining <= 0) { clearInterval(G.timerInterval); if (onExpire) onExpire(); return; }
    G.timerSecondsRemaining--;
  }
  tick();
  G.timerInterval = setInterval(tick, 1000);
}

function clearTimers() {
  if (G.timerInterval) { clearInterval(G.timerInterval); G.timerInterval = null; }
}

// ─── UTILITIES ────────────────────────────────────────────────────────────────
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function copyJoinLink() {
  const url = document.getElementById('joinUrlDisplay').textContent;
  navigator.clipboard.writeText(url)
    .then(() => toast('Link copied!', 'success'))
    .catch(() => toast('Copy: ' + url, 'success', 5000));
}

function updatePreview() {}

// Timer select show/hide custom input
['cf-sub-timer', 'cf-vote-timer'].forEach(id => {
  document.getElementById(id)?.addEventListener('change', function () {
    document.getElementById(id + '-custom').style.display = this.value === 'custom' ? 'block' : 'none';
  });
});

// Handle ?join=CODE in URL
window.addEventListener('load', () => {
  const params   = new URLSearchParams(window.location.search);
  const joinCode = params.get('join');
  if (joinCode) {
    document.getElementById('joinCodeInput').value = joinCode.toUpperCase();
    document.getElementById('joinNameInput').focus();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (document.getElementById('view-voting').classList.contains('active')) {
    if (e.key >= '1' && e.key <= '5') {
      const btn = document.querySelectorAll('.vote-btn')[parseInt(e.key) - 1];
      if (btn) castVote(btn, parseInt(e.key));
    }
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') voteNext();
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowUp')   votePrev();
  }
  if (document.getElementById('view-submission').classList.contains('active')) {
    if (e.key === 'Enter' && e.metaKey) subNext();
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-backdrop.active').forEach(m => m.classList.remove('active'));
  }
});

// ─── BOOT ─────────────────────────────────────────────────────────────────────
// Inject Supabase JS SDK then initialise
(function loadSupabase() {
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
  s.onload = initSupabase;
  s.onerror = () => toast('Could not load Supabase SDK. Check your internet connection.', 'error', 8000);
  document.head.appendChild(s);
})();
</script>
</body>
</html>
